<!-- Navbar -->
<nav class="bg-white shadow">
  <div class="max-w-7xl mx-auto px-4 py-3 flex justify-between items-center">

    <!-- Izquierda: logo m√°s bienvenida -->
    <a href="javascript:void(0)" class="flex items-center gap-2">
      <img src="/img/logo.png" alt="TasksFlow" class="h-16 w-auto">
      <span class="font-semibold text-lg text-[#2E7D32] hidden sm:inline">
        <%= user ? user.name : 'TasksFlow' %>
      </span>
    </a>

    <!-- Derecha: bot√≥n Nueva company + Logout -->
    <div class="flex items-center gap-4">
      <!-- Bot√≥n: registrar nueva empresa -->
      <button
        type="button"
        onclick="toggleModal('modalNuevaCompany', true)"
        class="inline-flex items-center gap-1 px-3 py-1 rounded-lg bg-[#2E7D32] text-white text-sm hover:bg-[#1B5E20]">
        <span class="material-symbols-outlined text-sm">business</span>
        <span>Nueva empresa</span>
      </button>

      <!-- Bot√≥n: gesti√≥n usuarios admin -->
      <button
        type="button"
        onclick="toggleModal('modalRootAdminUsers', true)"
        class="inline-flex items-center gap-1 px-3 py-1 rounded-lg border border-[#2E7D32] text-[#2E7D32] text-xs hover:bg-[#E8F5E9]">
        <span class="material-symbols-outlined text-sm">admin_panel_settings</span>
        <span>Usuarios admin</span>
      </button>

      <a href="/logout"
        onclick="return doLogout()"
        class="px-3 py-1 rounded-lg bg-[#F87171] text-white hover:bg-[#EF4444]">
        Logout
      </a>
    </div>
  </div>
</nav>

<!-- Section: Empresas registradas -->
<section class="bg-white rounded-2xl shadow p-6 max-w-6xl mx-auto my-8">
  <h2 class="text-xl font-semibold text-[#2E7D32] mb-2">Empresas registradas</h2>
  <p class="text-sm text-gray-600 mb-4">
    Gesti√≥n de companies (solo root).
  </p>

  <div class="flex justify-end mb-3">
    <button
      type="button"
      onclick="toggleModal('modalNuevaCompany', true)"
      class="inline-flex items-center gap-1 px-3 py-1 rounded-lg border border-[#2E7D32] text-[#2E7D32] text-xs hover:bg-[#E8F5E9]">
      <span class="material-symbols-outlined text-sm">add</span>
      <span>Nueva empresa</span>
    </button>
  </div>

  <div class="overflow-x-auto">
    <table class="min-w-full text-sm">
      <thead>
        <tr class="text-left text-gray-500 border-b text-xs uppercase">
          <th class="py-2 pr-3">Nombre</th>
          <th class="py-2 pr-3">Descripci√≥n</th>
          <th class="py-2 pr-3">Estado</th>
          <th class="py-2 pr-3">Creada</th>
        </tr>
      </thead>
      <tbody class="divide-y text-xs sm:text-sm">
        <% if (companies && companies.length) { %>
          <% companies.forEach(function(c) { %>
            <tr>
              <td class="py-2 pr-3 font-medium text-gray-800"><%= c.name %></td>
              <td class="py-2 pr-3"><%= c.description || '-' %></td>
              <td class="py-2 pr-3">
                <span class="px-2 py-0.5 rounded-full text-[11px] font-semibold
                  <%= c.status === 'active' ? 'bg-[#E8F5E9] text-[#2E7D32]' : 'bg-gray-100 text-gray-600' %>">
                  <%= c.status === 'active' ? 'Activa' : 'Inactiva' %>
                </span>
              </td>
              <td class="py-2 pr-3"><%= c.created_at ? c.created_at.toISOString().slice(0,10) : '' %></td>
            </tr>
          <% }) %>
        <% } else { %>
          <tr>
            <td colspan="4" class="py-4 text-center text-gray-500">
              No hay empresas registradas a√∫n.
            </td>
          </tr>
        <% } %>
      </tbody>
    </table>
  </div>
</section>

<!-- Section: Usuarios Admin -->
<section class="bg-white rounded-2xl shadow p-6 max-w-6xl mx-auto my-8">
  <h2 class="text-xl font-semibold text-[#2E7D32] mb-2">Usuarios Admin</h2>
  <p class="text-sm text-gray-600 mb-4">
    Usuarios con rol Admin asociados a una compa√±√≠a.
  </p>

  <div class="overflow-x-auto">
    <table class="min-w-full text-sm">
      <thead>
        <tr class="text-left text-gray-500 border-b text-xs uppercase">
          <th class="py-2 pr-3">Nombre</th>
          <th class="py-2 pr-3">Email</th>
          <th class="py-2 pr-3">Empresa</th>
          <th class="py-2 pr-3">Estado</th>
          <th class="py-2 pr-3">Creado</th>
        </tr>
      </thead>
      <tbody class="divide-y text-xs sm:text-sm">
        <% if (adminUsers && adminUsers.length) { %>
          <% adminUsers.forEach(function(u) { %>
            <tr>
              <td class="py-2 pr-3 font-medium text-gray-800">
                <%= u.name %>
              </td>
              <td class="py-2 pr-3 text-gray-700">
                <%= u.email %>
              </td>
              <td class="py-2 pr-3 text-gray-700">
                <%= u.company_name || 'Sin empresa' %>
              </td>
              <td class="py-2 pr-3">
                <span class="inline-flex items-center px-2 py-0.5 rounded-full text-[11px]
                  <%= u.status === 'active' ? 'bg-green-100 text-green-700' : 'bg-gray-200 text-gray-700' %>">
                  <%= u.status === 'active' ? 'Activo' : 'Inactivo' %>
                </span>
              </td>
              <td class="py-2 pr-3 text-gray-500">
                <%= u.created_at ? u.created_at.toISOString().slice(0, 10) : '' %>
              </td>
            </tr>
          <% }) %>
        <% } else { %>
          <tr>
            <td colspan="5" class="py-4 text-center text-gray-400">
              No hay usuarios admin registrados a√∫n.
            </td>
          </tr>
        <% } %>
      </tbody>
    </table>
  </div>
</section>

<!-- MODAL: Registrar / Editar empresa -->
<div
  id="modalNuevaCompany"
  class="fixed inset-0 z-40 hidden items-center justify-center bg-black/40">
  <div class="bg-white rounded-2xl shadow-lg w-full max-w-md mx-4">
    
    <!-- Header -->
    <div class="px-5 py-3 border-b flex justify-between items-center">
      <h3 class="text-base font-semibold text-gray-800">
        Gesti√≥n de empresas
      </h3>
      <button
        type="button"
        class="text-gray-500 hover:text-gray-700"
        onclick="toggleModal('modalNuevaCompany', false)">
        ‚úï
      </button>
    </div>

    <!-- Tabs -->
    <div class="px-5 pt-3 border-b flex gap-4 text-sm">
      <button
        id="tabCompanyRegistrar"
        type="button"
        class="pb-2 border-b-2 border-[#2E7D32] text-[#2E7D32] font-medium"
        onclick="switchCompanyTab('registrar')">
        Registrar empresa
      </button>
      <button
        id="tabCompanyEditar"
        type="button"
        class="pb-2 border-b-2 border-transparent text-gray-500 hover:text-gray-700"
        onclick="switchCompanyTab('editar')">
        Editar empresa
      </button>
    </div>

    <!-- Contenido -->
    <div class="px-5 py-4 text-sm">
      <!-- TAB: REGISTRAR -->
      <div id="tabContentCompanyRegistrar" class="space-y-3">
        <form
          id="formNuevaCompany"
          class="space-y-3">

          <!-- Nombre de la empresa -->
          <div>
            <label class="block text-xs font-medium text-gray-700 mb-1">Nombre de la empresa</label>
            <input
              type="text"
              name="name"
              class="w-full border rounded-lg px-3 py-2 focus:outline-none focus:ring-1 focus:ring-[#2E7D32]"
              placeholder="Ej: Empresa TasksFlow"
              required>
          </div>

          <!-- Descripci√≥n -->
          <div>
            <label class="block text-xs font-medium text-gray-700 mb-1">Descripci√≥n</label>
            <textarea
              name="description"
              rows="2"
              class="w-full border rounded-lg px-3 py-2 focus:outline-none focus:ring-1 focus:ring-[#2E7D32]"
              placeholder="Notas o alcance de la empresa‚Ä¶"></textarea>
          </div>

          <!-- Estado -->
          <div>
            <label class="block text-xs font-medium text-gray-700 mb-1">Estado</label>
            <select
              name="status"
              class="w-full border rounded-lg px-3 py-2 bg-white focus:outline-none focus:ring-1 focus:ring-[#2E7D32]"
              required>
              <option value="active">Activa</option>
              <option value="inactive">Inactiva</option>
            </select>
          </div>

          <!-- Footer (Registrar) -->
          <div class="flex justify-end gap-2 pt-2">
            <button
              type="button"
              onclick="toggleModal('modalNuevaCompany', false)"
              class="px-3 py-1.5 rounded-lg text-xs border text-gray-600 hover:bg-gray-50">
              Cancelar
            </button>
            <button
              type="submit"
              class="px-3 py-1.5 rounded-lg text-xs bg-[#2E7D32] text-white hover:bg-[#1B5E20]">
              Guardar
            </button>
          </div>
        </form>
      </div>

      <!-- TAB: EDITAR -->
      <div id="tabContentCompanyEditar" class="space-y-3 hidden">
        <form
          id="formEditarCompany"
          class="space-y-3">
          
          <!-- Selector de empresa -->
          <div>
            <label class="block text-xs font-medium text-gray-700 mb-1">Empresa a editar</label>
            <select
              id="selectCompanyEditar"
              name="company_id"
              class="w-full border rounded-lg px-3 py-2 bg-white focus:outline-none focus:ring-1 focus:ring-[#2E7D32]"
              required>
              <option value="" disabled selected>Seleccionar empresa‚Ä¶</option>
              <% if (companies && companies.length) { %>
                <% companies.forEach(function(c) { %>
                  <option value="<%= c.id %>">
                    <%= c.name %> (<%= c.status === 'active' ? 'Activa' : 'Inactiva' %>)
                  </option>
                <% }) %>
              <% } %>
            </select>
          </div>

          <!-- Nombre -->
          <div>
            <label class="block text-xs font-medium text-gray-700 mb-1">Nombre de la empresa</label>
            <input
              type="text"
              id="editarCompanyName"
              name="name"
              class="w-full border rounded-lg px-3 py-2 focus:outline-none focus:ring-1 focus:ring-[#2E7D32]"
              required>
          </div>

          <!-- Descripci√≥n -->
          <div>
            <label class="block text-xs font-medium text-gray-700 mb-1">Descripci√≥n</label>
            <textarea
              id="editarCompanyDescription"
              name="description"
              rows="2"
              class="w-full border rounded-lg px-3 py-2 focus:outline-none focus:ring-1 focus:ring-[#2E7D32]"></textarea>
          </div>

          <!-- Estado -->
          <div>
            <label class="block text-xs font-medium text-gray-700 mb-1">Estado</label>
            <select
              id="editarCompanyStatus"
              name="status"
              class="w-full border rounded-lg px-3 py-2 bg-white focus:outline-none focus:ring-1 focus:ring-[#2E7D32]">
              <option value="active">Activa</option>
              <option value="inactive">Inactiva</option>
            </select>
          </div>

          <!-- Footer (Editar) -->
          <div class="flex justify-end gap-2 pt-2">
            <button
              type="button"
              onclick="toggleModal('modalNuevaCompany', false)"
              class="px-3 py-1.5 rounded-lg text-xs border text-gray-600 hover:bg-gray-50">
              Cancelar
            </button>
            <button
              type="submit"
              class="px-3 py-1.5 rounded-lg text-xs bg-[#2E7D32] text-white hover:bg-[#1B5E20]">
              Guardar cambios
            </button>
          </div>
        </form>
      </div>
    </div>

  </div>
</div>

<!-- MODAL: Registrar / Editar usuarios ADMIN (solo root) -->
<div
  id="modalRootAdminUsers"
  class="fixed inset-0 z-40 hidden items-center justify-center bg-black/40">
  <div class="bg-white rounded-2xl shadow-lg w-full max-w-lg mx-4">

    <!-- Header -->
    <div class="px-5 py-3 border-b flex justify-between items-center">
      <h3 class="text-base font-semibold text-gray-800">
        Gesti√≥n de usuarios Admin
      </h3>
      <button
        type="button"
        class="text-gray-500 hover:text-gray-700"
        onclick="toggleModal('modalRootAdminUsers', false)">
        ‚úï
      </button>
    </div>

    <!-- Tabs -->
    <div class="px-5 pt-3 border-b flex gap-4 text-sm">
      <button
        id="tabRootAdminRegistrar"
        type="button"
        class="pb-2 border-b-2 border-[#2E7D32] text-[#2E7D32] font-medium"
        onclick="switchRootAdminTab('registrar')">
        Registrar Admin
      </button>
      <button
        id="tabRootAdminEditar"
        type="button"
        class="pb-2 border-b-2 border-transparent text-gray-500 hover:text-gray-700"
        onclick="switchRootAdminTab('editar')">
        Editar Admin
      </button>
    </div>

    <!-- Contenido -->
    <div class="px-5 py-4 text-sm">
      <!-- TAB: REGISTRAR -->
      <div id="tabContentRootAdminRegistrar" class="space-y-3">
        <form id="formRootNuevoAdmin" class="space-y-3">
          <!-- Nombre -->
          <div>
            <label class="block text-xs font-medium text-gray-700 mb-1">Nombre</label>
            <input
              type="text"
              name="name"
              class="w-full border rounded-lg px-3 py-2 focus:outline-none focus:ring-1 focus:ring-[#2E7D32]"
              required>
          </div>

          <!-- Email -->
          <div>
            <label class="block text-xs font-medium text-gray-700 mb-1">Email</label>
            <input
              type="email"
              name="email"
              class="w-full border rounded-lg px-3 py-2 focus:outline-none focus:ring-1 focus:ring-[#2E7D32]"
              required>
          </div>

          <!-- Tel√©fono -->
          <div>
            <label class="block text-xs font-medium text-gray-700 mb-1">Tel√©fono</label>
            <input
              type="tel"
              name="telephone"
              class="w-full border rounded-lg px-3 py-2 focus:outline-none focus:ring-1 focus:ring-[#2E7D32]">
          </div>

          <!-- Company obligatoria -->
          <div>
            <label class="block text-xs font-medium text-gray-700 mb-1">Empresa</label>
            <select
              name="company_id"
              class="w-full border rounded-lg px-3 py-2 bg-white focus:outline-none focus:ring-1 focus:ring-[#2E7D32]"
              required>
              <option value="" disabled selected>Selecciona una empresa‚Ä¶</option>
              <% if (companies && companies.length) { %>
                <% companies.forEach(function(c) { %>
                  <option value="<%= c.id %>"><%= c.name %></option>
                <% }) %>
              <% } %>
            </select>
            <p class="mt-1 text-[11px] text-gray-400">
              * Todo usuario Admin debe pertenecer a una empresa existente.
            </p>
          </div>

          <!-- Rol fijo = admin -->
          <div>
            <label class="block text-xs font-medium text-gray-700 mb-1">Rol</label>
            <select
              name="role"
              class="w-full border rounded-lg px-3 py-2 bg-white focus:outline-none focus:ring-1 focus:ring-[#2E7D32]"
              required>
              <option value="admin" selected>Admin</option>
            </select>
            <p class="mt-1 text-[11px] text-gray-400">
              * Como Root, solo puedes registrar usuarios de tipo Admin.
            </p>
          </div>

          <!-- Estado -->
          <div>
            <label class="block text-xs font-medium text-gray-700 mb-1">Estado</label>
            <select
              name="status"
              class="w-full border rounded-lg px-3 py-2 bg-white focus:outline-none focus:ring-1 focus:ring-[#2E7D32]"
              required>
              <option value="active" selected>Activo</option>
              <option value="suspended">Inactivo</option>
            </select>
          </div>

          <!-- Footer -->
          <div class="flex justify-end gap-2 pt-2">
            <button
              type="button"
              onclick="toggleModal('modalRootAdminUsers', false)"
              class="px-3 py-1.5 rounded-lg text-xs border text-gray-600 hover:bg-gray-50">
              Cancelar
            </button>
            <button
              type="submit"
              class="px-3 py-1.5 rounded-lg text-xs bg-[#2E7D32] text-white hover:bg-[#1B5E20]">
              Guardar
            </button>
          </div>
        </form>
      </div>

      <!-- TAB: EDITAR -->
      <div id="tabContentRootAdminEditar" class="space-y-3 hidden">
        <form id="formRootEditarAdmin" class="space-y-3">
          <!-- Selector usuario admin -->
          <div>
            <label class="block text-xs font-medium text-gray-700 mb-1">Usuario Admin</label>
            <select
              id="selectRootAdminEditar"
              name="user_id"
              class="w-full border rounded-lg px-3 py-2 bg-white focus:outline-none focus:ring-1 focus:ring-[#2E7D32]"
              required>
              <option value="" disabled selected>Seleccionar usuario‚Ä¶</option>
              <% if (adminUsers && adminUsers.length) { %>
                <% adminUsers.forEach(function(u) { %>
                  <option value="<%= u.id %>">
                    <%= u.name %> - <%= u.email %> (<%= u.company_name || 'sin company' %>)
                  </option>
                <% }) %>
              <% } %>
            </select>
          </div>

          <!-- Nombre -->
          <div>
            <label class="block text-xs font-medium text-gray-700 mb-1">Nombre</label>
            <input
              type="text"
              id="rootEditarAdminName"
              name="name"
              class="w-full border rounded-lg px-3 py-2 focus:outline-none focus:ring-1 focus:ring-[#2E7D32]"
              required>
          </div>

          <!-- Email -->
          <div>
            <label class="block text-xs font-medium text-gray-700 mb-1">Email</label>
            <input
              type="email"
              id="rootEditarAdminEmail"
              name="email"
              class="w-full border rounded-lg px-3 py-2 focus:outline-none focus:ring-1 focus:ring-[#2E7D32]"
              required>
          </div>

          <!-- Tel√©fono -->
          <div>
            <label class="block text-xs font-medium text-gray-700 mb-1">Tel√©fono</label>
            <input
              type="tel"
              id="rootEditarAdminTel"
              name="telephone"
              class="w-full border rounded-lg px-3 py-2 focus:outline-none focus:ring-1 focus:ring-[#2E7D32]">
          </div>

          <!-- Empresa -->
          <div>
            <label class="block text-xs font-medium text-gray-700 mb-1">Empresa</label>
            <select
              id="rootEditarAdminCompany"
              name="company_id"
              class="w-full border rounded-lg px-3 py-2 bg-white focus:outline-none focus:ring-1 focus:ring-[#2E7D32]"
              required>
              <option value="" disabled selected>Selecciona una empresa‚Ä¶</option>
              <% if (companies && companies.length) { %>
                <% companies.forEach(function(c) { %>
                  <option value="<%= c.id %>"><%= c.name %></option>
                <% }) %>
              <% } %>
            </select>
          </div>

          <!-- Estado -->
          <div>
            <label class="block text-xs font-medium text-gray-700 mb-1">Estado</label>
            <select
              id="rootEditarAdminStatus"
              name="status"
              class="w-full border rounded-lg px-3 py-2 bg-white focus:outline-none focus:ring-1 focus:ring-[#2E7D32]"
              required>
              <option value="active">Activo</option>
              <option value="suspended">Inactivo</option>
            </select>
          </div>

          <!-- Rol fijo = admin (solo info) -->
          <div>
            <label class="block text-xs font-medium text-gray-700 mb-1">Rol</label>
            <input
              type="text"
              value="Admin"
              disabled
              class="w-full border rounded-lg px-3 py-2 bg-gray-50 text-gray-500 text-xs">
          </div>

          <!-- Footer -->
          <div class="flex justify-end gap-2 pt-2">
            <button
              type="button"
              onclick="toggleModal('modalRootAdminUsers', false)"
              class="px-3 py-1.5 rounded-lg text-xs border text-gray-600 hover:bg-gray-50">
              Cancelar
            </button>
            <!-- Resetear contrase√±a a la gen√©rica -->
            <button
              type="button"
              onclick="resetPasswordUsuarioSupervisor()"
              class="px-3 py-1.5 rounded-lg text-xs border border-amber-400 text-amber-600 hover:bg-amber-50">
              Reset pass gen√©rica
            </button>
            <button
              type="submit"
              class="px-3 py-1.5 rounded-lg text-xs bg-[#2E7D32] text-white hover:bg-[#1B5E20]">
              Guardar cambios
            </button>
          </div>
        </form>
      </div>
    </div>

  </div>
</div>

<!-- Script: Control de pesta√±as para registrar / editar companies -->
<script>
  function switchCompanyTab(tab) {
    const tabRegistrar = document.getElementById('tabCompanyRegistrar');
    const tabEditar = document.getElementById('tabCompanyEditar');
    const contentRegistrar = document.getElementById('tabContentCompanyRegistrar');
    const contentEditar = document.getElementById('tabContentCompanyEditar');

    if (tab === 'registrar') {
      tabRegistrar.classList.add('border-[#2E7D32]', 'text-[#2E7D32]');
      tabRegistrar.classList.remove('border-transparent', 'text-gray-500');
      tabEditar.classList.add('border-transparent', 'text-gray-500');
      tabEditar.classList.remove('border-[#2E7D32]', 'text-[#2E7D32]');

      contentRegistrar.classList.remove('hidden');
      contentEditar.classList.add('hidden');
    } else {
      tabEditar.classList.add('border-[#2E7D32]', 'text-[#2E7D32]');
      tabEditar.classList.remove('border-transparent', 'text-gray-500');
      tabRegistrar.classList.add('border-transparent', 'text-gray-500');
      tabRegistrar.classList.remove('border-[#2E7D32]', 'text-[#2E7D32]');

      contentEditar.classList.remove('hidden');
      contentRegistrar.classList.add('hidden');
    }
  }

  // lo dejamos en window por si lo llama toggleModal
  window.switchCompanyTab = switchCompanyTab;
</script>

<!-- Funci√≥n: Editar companies (flujo completo) -->
<script>
  const selectCompanyEditar = document.getElementById('selectCompanyEditar');
  const formEditarCompany = document.getElementById('formEditarCompany');
  const inputEditarCompanyName = document.getElementById('editarCompanyName');
  const inputEditarCompanyDesc = document.getElementById('editarCompanyDescription');
  const selectEditarCompanyStatus = document.getElementById('editarCompanyStatus');

  if (selectCompanyEditar && formEditarCompany) {
    // 1) Cuando se elije una empresa del combo, se cargan sus datos desde la API
    selectCompanyEditar.addEventListener('change', async () => {
      const id = selectCompanyEditar.value;
      if (!id) return;

      try {
        const res = await fetch(`/api/companies/${id}`, {
          credentials: 'same-origin'
        });
        const data = await res.json();

        if (!data.ok) {
          alert(data.message || 'No se pudo cargar la empresa');
          return;
        }

        const c = data.data;
        inputEditarCompanyName.value = c.name || '';
        inputEditarCompanyDesc.value = c.description || '';
        selectEditarCompanyStatus.value = c.status || 'active';
      } catch (err) {
        console.error(err);
        alert('Error al cargar la empresa');
      }
    });

    // 2) Al enviar el formulario, se mandan los cambios a /api/companies/:id/edit
    formEditarCompany.addEventListener('submit', async (e) => {
      e.preventDefault();
      const id = selectCompanyEditar.value;

      if (!id) {
        alert('Selecciona una empresa primero');
        return;
      }

      try {
        const body = new URLSearchParams(new FormData(formEditarCompany));

        const res = await fetch(`/api/companies/${id}/edit`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/x-www-form-urlencoded;charset=UTF-8'
          },
          body,
          credentials: 'same-origin'
        });

        const data = await res.json();
        alert(data.message || 'Cambios guardados');

        if (data.ok) {
          window.location.reload();
        }
      } catch (err) {
        console.error(err);
        alert('Error al actualizar la empresa');
      }
    });
  }
</script>

<script>
  // Tabs modal Root Admin
  function switchRootAdminTab(tab) {
    const tabReg = document.getElementById('tabRootAdminRegistrar');
    const tabEdit = document.getElementById('tabRootAdminEditar');
    const contentReg = document.getElementById('tabContentRootAdminRegistrar');
    const contentEdit = document.getElementById('tabContentRootAdminEditar');

    if (tab === 'registrar') {
      tabReg.classList.add('border-[#2E7D32]', 'text-[#2E7D32]');
      tabReg.classList.remove('border-transparent', 'text-gray-500');
      tabEdit.classList.add('border-transparent', 'text-gray-500');
      tabEdit.classList.remove('border-[#2E7D32]', 'text-[#2E7D32]');
      contentReg.classList.remove('hidden');
      contentEdit.classList.add('hidden');
    } else {
      tabEdit.classList.add('border-[#2E7D32]', 'text-[#2E7D32]');
      tabEdit.classList.remove('border-transparent', 'text-gray-500');
      tabReg.classList.add('border-transparent', 'text-gray-500');
      tabReg.classList.remove('border-[#2E7D32]', 'text-[#2E7D32]');
      contentEdit.classList.remove('hidden');
      contentReg.classList.add('hidden');
    }
  }

  window.switchRootAdminTab = switchRootAdminTab;
</script>

<script>
  // üéØ Elementos de edici√≥n de usuarios Admin (modal root)
  const formRootEditarAdmin   = document.getElementById('formRootEditarAdmin');
  const selectRootAdminEditar = document.getElementById('selectRootAdminEditar');

  const inputRootAdminName     = document.getElementById('rootEditarAdminName');
  const inputRootAdminEmail    = document.getElementById('rootEditarAdminEmail');
  const inputRootAdminTel      = document.getElementById('rootEditarAdminTel');
  const selectRootAdminCompany = document.getElementById('rootEditarAdminCompany');
  const selectRootAdminStatus  = document.getElementById('rootEditarAdminStatus');

  // Helper simple de mensajes (usa alert para no depender de notify)
  function showAdminMsg(payload) {
    if (!payload) {
      alert('Operaci√≥n realizada');
      return;
    }
    alert(payload.message || (payload.ok ? 'Operaci√≥n exitosa' : 'Ocurri√≥ un problema'));
  }

  // ============================
  // 1) Cargar datos al seleccionar usuario Admin
  // ============================
  if (selectRootAdminEditar) {
    selectRootAdminEditar.addEventListener('change', async () => {
      const id = selectRootAdminEditar.value;
      if (!id) return;

      try {
        const res = await fetch(`/api/root/admins/${id}`, {
          credentials: 'same-origin'
        });

        const data = await res.json();

        if (!data.ok) {
          showAdminMsg({
            ok: false,
            message: data.message || 'No se pudo cargar el usuario seleccionado'
          });
          return;
        }

        const u = data.data || {};

        // Rellenar campos del formulario
        inputRootAdminName.value  = u.name || '';
        inputRootAdminEmail.value = u.email || '';
        inputRootAdminTel.value   = u.telephone || '';

        if (u.company_id && selectRootAdminCompany) {
          selectRootAdminCompany.value = String(u.company_id);
        }

        if (selectRootAdminStatus) {
          selectRootAdminStatus.value = u.status || 'active';
        }
      } catch (err) {
        console.error('Error al cargar usuario admin:', err);
        showAdminMsg({
          ok: false,
          message: 'Error inesperado al cargar el usuario Admin'
        });
      }
    });
  }

  // ============================
  // 2) Guardar cambios del usuario Admin
  // ============================
  if (formRootEditarAdmin) {
    formRootEditarAdmin.addEventListener('submit', async (e) => {
      e.preventDefault();

      const id = selectRootAdminEditar ? selectRootAdminEditar.value : null;
      if (!id) {
        showAdminMsg({
          ok: false,
          message: 'Selecciona un usuario Admin antes de guardar los cambios'
        });
        return;
      }

      try {

        const body = new URLSearchParams(new FormData(formRootEditarAdmin));

        const res = await fetch(`/api/root/admins/${id}/edit`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/x-www-form-urlencoded;charset=UTF-8'
          },
          body,
          credentials: 'same-origin'
        });

        const data = await res.json();
        showAdminMsg(data);

        if (data.ok) {
          // cerrar modal y recargar la tabla
          toggleModal('modalRootAdminUsers', false);
          window.location.reload();
        }
      } catch (err) {
        console.error('Error al actualizar usuario admin:', err);
        showAdminMsg({
          ok: false,
          message: 'Error inesperado al actualizar el usuario Admin'
        });
      }
    });
  }
</script>

<!-- Resetear contrase√±a a la gen√©rica -->
<script>
  async function resetPasswordUsuarioSupervisor() {
    // Usamos el select correcto del modal root: selectRootAdminEditar
    if (!selectRootAdminEditar) {
      alert('No se encontr√≥ el selector de usuarios Admin.');
      return;
    }

    const id = selectRootAdminEditar.value;
    if (!id) {
      alert('Selecciona un usuario Admin primero.');
      return;
    }

    const confirmar = confirm(
      '¬øSeguro que deseas resetear la contrase√±a de este usuario ' +
      'a la contrase√±a gen√©rica del sistema?'
    );
    if (!confirmar) return;

    try {
      const res = await fetch(`/api/users/${id}/reset-password`, {
        method: 'POST',
        headers: {
          'Content-Type': 'application/x-www-form-urlencoded;charset=UTF-8'
        },
        credentials: 'same-origin'
      });

      const data = await res.json();
      alert(data.message || 'Operaci√≥n realizada.');
    } catch (err) {
      console.error(err);
      alert('Error al resetear la contrase√±a.');
    }
  }

  // Exponer funci√≥n al scope global para usarla en onclick
  window.resetPasswordUsuarioSupervisor = resetPasswordUsuarioSupervisor;
</script>