<!-- Navbar personalizada admin -->
<nav class="bg-white shadow">
  <div class="max-w-7xl mx-auto px-4 py-3 flex justify-between items-center">

    <!-- Izquierda: logo más bienvenida -->
    <a href="javascript:void(0)" class="flex items-center gap-2">
      <img src="/img/logo.png" alt="TasksFlow" class="h-16 w-auto">
      <span class="font-semibold text-lg text-[#2E7D32] hidden sm:inline">
        <%= user ? user.name : 'TasksFlow' %>
      </span>
    </a>

    <!-- Derecha: botones modales y vista kanban -->
    <div class="flex items-center gap-3">

      <!-- Botón: nueva área de trabajo -->
      <button 
        id="btnAdminNuevaArea"
        type="button"
        onclick="toggleModal('modalNuevaArea', true)"
        class="hidden sm:inline-flex items-center gap-1 px-3 py-1 rounded-lg bg-[#0288D1] text-white text-sm hover:bg-[#0277BD]">
        <span class="material-symbols-outlined text-sm">add</span>
        <span>área</span>
        <span class="material-symbols-outlined text-sm">edit</span>
      </button>

      <!-- Botón: registrar usuario -->
      <button 
        id="btnAdminNuevoUsuario"
        type="button"
        onclick="toggleModal('modalNuevoUsuario', true)"
        class="hidden sm:inline-flex items-center gap-1 px-3 py-1 rounded-lg bg-[#2E7D32] text-white text-sm hover:bg-[#1B5E20]">
        <span class="material-symbols-outlined text-sm">add</span>
        <span>usuario</span>
        <span class="material-symbols-outlined text-sm">edit</span>
      </button>

      <!-- Botón: Nuevo team (grupo de trabajo) -->
      <button
        id="btnAdminNuevoGrupo"
        type="button"
        onclick="toggleModal('modalNuevoGrupo', true)"
        class="hidden sm:inline-flex items-center gap-1 px-3 py-1 rounded-lg bg-[#7B1FA2] text-white text-sm hover:bg-[#6A1B9A]">
        <span class="material-symbols-outlined text-sm">add</span>
        <span>team</span>
        <span class="material-symbols-outlined text-sm">edit</span>
      </button>

      <!-- Botón: Editar team (grupo de trabajo) -->
      <button
        id="btnAdminEditarGrupo"
        type="button"
        onclick="toggleModal('modalEditarGrupo', true)"
        class="hidden sm:inline-flex items-center gap-1 px-3 py-1 rounded-lg bg-[#0284C7] text-white text-sm hover:bg-[#0369A1]">
        <span class="material-symbols-outlined text-sm">group</span>
        <span>team</span>
      </button>
      
      <!-- Botón para gestionar proyectos (solo modo Kanban en admin) -->
      <button
        id="btnAdminProyectos"
        type="button"
        onclick="toggleModal('modalNuevoProyecto', true)"
        class="hidden inline-flex items-center gap-1 px-3 py-1 rounded-lg border border-[#7B1FA2] text-[#7B1FA2] text-sm bg-white hover:bg-[#F3E5F5]">
        <span class="material-symbols-outlined text-sm">folder_special</span>
        <span>Proyectos</span>
      </button>

      <!-- Botón para registrar tarea (solo modo Kanban en admin) -->
      <button
        id="btnAdminNuevaTarea"
        type="button"
        onclick="toggleModal('modalNuevaTarea', true)"
        class="hidden inline-flex items-center gap-1 px-3 py-1 rounded-lg bg-[#2E7D32] text-white text-sm hover:bg-[#1B5E20]">
        <span class="material-symbols-outlined text-sm">task_alt</span>
        <span>Nueva tarea</span>
      </button>

      <!-- Menú simple para móviles -->
      <div class="sm:hidden">
        <select
          class="border rounded-lg px-2 py-1 text-sm"
          onchange="handleAdminQuickAction(this)">
          <option value="">Acciones</option>
          <option value="nuevoUsuario">Nuevo usuario</option>
          <option value="nuevaArea">Nueva área/equipo</option>
          <option value="nuevoGrupo">Nuevo grupo de trabajo</option>
        </select>
      </div>

      <!-- Toggle vista Kanban -->
      <label
        id="kanbanToggleLabel"
        class="inline-flex items-center gap-1 px-3 py-1 rounded-lg border text-sm cursor-pointer bg-white text-gray-700 hover:bg-[#E8F5E9]">
        <input
          id="kanbanToggle"
          type="checkbox"
          class="sr-only"
          onchange="toggleKanbanView(this)">
        <span class="material-icons text-base">view_module</span>
        <span>Kanban</span>
      </label>

      <!-- Logout -->
      <a href="/logout"
        onclick="return doLogout()"
        class="px-3 py-1 rounded-lg bg-[#F87171] text-white hover:bg-[#EF4444] text-sm">
        Logout
      </a>
    </div>
  </div>
</nav>

<%
  const projectsSafe = (
    typeof projects !== 'undefined' && Array.isArray(projects)
      ? projects
      : []
  );
%>

<script>
  window.currentUserId = "<%= user ? user.id : '' %>";
  window.projectsAdmin = <%- JSON.stringify(projectsSafe) %>;
</script>

<!-- VISTA DASHBOARD ADMIN (vista por defecto) -->
<section
  id="adminDashboardView"
  class="bg-white rounded-2xl p-6 shadow max-w-6xl mx-auto my-8"
>
  <%
    const areasSafe = (
      typeof areas !== 'undefined' && Array.isArray(areas)
        ? areas
        : []
    );
    const usersSafe = (
      typeof users !== 'undefined' && Array.isArray(users)
        ? users
        : []
    );
    const teamsSafe = (
      typeof teams !== 'undefined' && Array.isArray(teams)
        ? teams
        : []
    );
    const tasksSafe = (
      typeof tasks !== 'undefined' && Array.isArray(tasks)
        ? tasks
        : []
    );

    const totalAreas = areasSafe.length;
    const totalUsers = usersSafe.length;
    const totalTeams = teamsSafe.length;

    function countByStatus(status) {
      return tasksSafe.filter(function (t) {
        return t && t.status === status;
      }).length;
    }

    const totalTasks      = tasksSafe.length;
    const pendingCount    = countByStatus('pending');
    const inProgressCount = countByStatus('in_progress');
    const reviewCount     = countByStatus('review');
    const doneCount       = countByStatus('done');
  %>

  <!-- Encabezado -->
  <h2 class="text-xl font-semibold text-[#2E7D32] mb-1">
    Panel Admin · Visión general de la compañía
  </h2>
  <p class="text-sm text-gray-600 mb-4">
    Resumen de áreas, equipos, usuarios y tareas de la empresa actual.
  </p>

  <!-- Cards resumen principales -->
  <div class="grid gap-4 sm:grid-cols-4 mb-6">
    <div class="bg-[#F1F8E9] rounded-xl p-4">
      <p class="text-xs text-gray-500 mb-1">Áreas activas</p>
      <p class="text-2xl font-semibold text-[#33691E]"><%= totalAreas %></p>
    </div>
    <div class="bg-[#E3F2FD] rounded-xl p-4">
      <p class="text-xs text-gray-500 mb-1">Usuarios</p>
      <p class="text-2xl font-semibold text-[#1565C0]"><%= totalUsers %></p>
    </div>
    <div class="bg-[#F3E5F5] rounded-xl p-4">
      <p class="text-xs text-gray-500 mb-1">Grupos de trabajo</p>
      <p class="text-2xl font-semibold text-[#7B1FA2]"><%= totalTeams %></p>
    </div>
    <div class="bg-[#FFF3E0] rounded-xl p-4">
      <p class="text-xs text-gray-500 mb-1">Tareas totales</p>
      <p class="text-2xl font-semibold text-[#EF6C00]"><%= totalTasks %></p>
    </div>
  </div>

  <!-- Resumen por estado de tareas -->
  <div class="grid gap-4 sm:grid-cols-4">
    <div class="bg-white border rounded-xl p-4">
      <p class="text-xs text-gray-500 mb-1">Pendientes</p>
      <p class="text-xl font-semibold text-gray-800"><%= pendingCount %></p>
    </div>
    <div class="bg-white border rounded-xl p-4">
      <p class="text-xs text-gray-500 mb-1">En progreso</p>
      <p class="text-xl font-semibold text-gray-800"><%= inProgressCount %></p>
    </div>
    <div class="bg-white border rounded-xl p-4">
      <p class="text-xs text-gray-500 mb-1">En revisión</p>
      <p class="text-xl font-semibold text-gray-800"><%= reviewCount %></p>
    </div>
    <div class="bg-white border rounded-xl p-4">
      <p class="text-xs text-gray-500 mb-1">Completadas</p>
      <p class="text-xl font-semibold text-gray-800"><%= doneCount %></p>
    </div>
  </div>
</section>

<!-- VISTA KANBAN ADMIN (inicialmente oculta) -->
<section
  id="adminKanbanView"
  class="bg-white rounded-2xl p-6 shadow max-w-6xl mx-auto my-8 hidden">

  <div class="flex flex-col md:flex-row md:justify-between md:items-center mb-4 gap-3">
    <!-- Izquierda: título + descripción -->
    <div>
      <h2 class="text-xl font-semibold text-[#2E7D32]">Tablero Kanban (Empresa)</h2>
      <p class="text-sm text-gray-600">
        Tareas de toda la empresa ordenadas por estado. Vista pensada para decisiones
        estratégicas: ver carga global y cuellos de botella.
      </p>
    </div>

    <!-- Derecha: select alineado (proyectos) -->
    <div class="bg-[#F1F8E9] rounded-xl p-3">
      <label for="filtroTarea" class="block text-xs font-medium text-gray-700 mb-1">
        Filtrar por proyecto
      </label>
      <select
        id="filtroTarea"
        class="block w-full rounded-lg border border-gray-300 text-sm px-2 py-1 bg-white focus:outline-none focus:ring-2 focus:ring-[#2E7D32]/60 focus:border-[#2E7D32]">

        <!-- todas -->
        <option value="">Todos los proyectos</option>

        <!-- solo tareas sin proyecto -->
        <option value="__no_project__">Tareas sin proyecto</option>

        <%
          const fp = (typeof projects !== 'undefined' && projects && projects.length)
            ? projects
            : [];
        %>
        <% if (fp.length) { %>
          <% fp.forEach(function(p) { %>
            <option value="<%= p.id %>">
              <%= p.name %>
            </option>
          <% }); %>
        <% } else { %>
          <option value="" disabled>(Sin proyectos aún en la empresa)</option>
        <% } %>
      </select>
    </div>
  </div>

  <!-- Columnas Kanban (mismo estilo que supervisor) -->
  <div class="grid gap-4 md:grid-cols-4">

    <!-- Pendientes -->
    <div class="bg-[#F1F8E9] rounded-xl p-3" data-column-status="pending">
      <h3 class="text-sm font-semibold text-gray-700 mb-1">Pendientes</h3>
      <p class="text-xs text-gray-500">Tareas que aún no comienzan.</p>
      <div class="mt-3 space-y-2 kanban-column-body">
        <% if (kanbanTasks && kanbanTasks.pending && kanbanTasks.pending.length) { %>
          <% kanbanTasks.pending.forEach(function (t) { %>
            <article
              class="p-3 bg-white rounded-lg shadow-sm border border-gray-200 text-sm cursor-move task-card"
              draggable="true"
              data-task-id="<%= t.id %>"
              data-task-status="pending"
              data-project-id="<%= t.project_id || '' %>"
              data-task-title="<%= t.title || t.name || '' %>"
              data-task-project="<%= t.project_name || '' %>"
              data-task-assignee="<%= t.assignee_name || '' %>">
              <h4 class="font-semibold text-gray-800"><%= t.title || t.name %></h4>

              <% if (t.project_name) { %>
                <p class="text-[11px] text-gray-500">
                  Proyecto: <%= t.project_name %>
                </p>
              <% } %>

              <% if (t.assignee_name) { %>
                <p class="text-[11px] text-gray-500">
                  Asignado a: <%= t.assignee_name %>
                </p>
              <% } %>
            </article>
          <% }); %>
        <% } else { %>
          <p class="text-xs text-gray-400 mt-2">
            No hay tareas pendientes en la empresa.
          </p>
        <% } %>
      </div>
    </div>

    <!-- En progreso -->
    <div class="bg-[#E3F2FD] rounded-xl p-3" data-column-status="in_progress">
      <h3 class="text-sm font-semibold text-gray-700 mb-1">En progreso</h3>
      <p class="text-xs text-gray-500">Tareas que se están ejecutando.</p>
      <div class="mt-3 space-y-2 kanban-column-body">
        <% if (kanbanTasks && kanbanTasks.in_progress && kanbanTasks.in_progress.length) { %>
          <% kanbanTasks.in_progress.forEach(function (t) { %>
            <article
              class="p-3 bg-white rounded-lg shadow-sm border border-gray-200 text-sm cursor-move task-card"
              draggable="true"
              data-task-id="<%= t.id %>"
              data-task-status="in_progress"
              data-project-id="<%= t.project_id || '' %>"
              data-task-title="<%= t.title || t.name || '' %>"
              data-task-project="<%= t.project_name || '' %>"
              data-task-assignee="<%= t.assignee_name || '' %>">
              <h4 class="font-semibold text-gray-800"><%= t.title || t.name %></h4>

              <% if (t.project_name) { %>
                <p class="text-[11px] text-gray-500">
                  Proyecto: <%= t.project_name %>
                </p>
              <% } %>

              <% if (t.assignee_name) { %>
                <p class="text-[11px] text-gray-500">
                  Asignado a: <%= t.assignee_name %>
                </p>
              <% } %>
            </article>
          <% }); %>
        <% } else { %>
          <p class="text-xs text-gray-400 mt-2">
            No hay tareas en progreso en la empresa.
          </p>
        <% } %>
      </div>
    </div>

    <!-- En revisión -->
    <div class="bg-[#FFFDE7] rounded-xl p-3" data-column-status="review">
      <h3 class="text-sm font-semibold text-gray-700 mb-1">En revisión</h3>
      <p class="text-xs text-gray-500">Tareas esperando revisión.</p>
      <div class="mt-3 space-y-2 kanban-column-body">
        <% if (kanbanTasks && kanbanTasks.review && kanbanTasks.review.length) { %>
          <% kanbanTasks.review.forEach(function (t) { %>
            <article
              class="p-3 bg-white rounded-lg shadow-sm border border-gray-200 text-sm cursor-move task-card"
              draggable="true"
              data-task-id="<%= t.id %>"
              data-task-status="review"
              data-project-id="<%= t.project_id || '' %>"
              data-task-title="<%= t.title || t.name || '' %>"
              data-task-project="<%= t.project_name || '' %>"
              data-task-assignee="<%= t.assignee_name || '' %>">
              <h4 class="font-semibold text-gray-800"><%= t.title || t.name %></h4>

              <% if (t.project_name) { %>
                <p class="text-[11px] text-gray-500">
                  Proyecto: <%= t.project_name %>
                </p>
              <% } %>

              <% if (t.assignee_name) { %>
                <p class="text-[11px] text-gray-500">
                  Asignado a: <%= t.assignee_name %>
                </p>
              <% } %>
            </article>
          <% }); %>
        <% } else { %>
          <p class="text-xs text-gray-400 mt-2">
            No hay tareas en revisión en la empresa.
          </p>
        <% } %>
      </div>
    </div>

    <!-- Completadas -->
    <div class="bg-[#FFF3E0] rounded-xl p-3" data-column-status="done">
      <h3 class="text-sm font-semibold text-gray-700 mb-1">Completadas</h3>
      <p class="text-xs text-gray-500">Tareas completadas.</p>
      <div class="mt-3 space-y-2 kanban-column-body">
        <% if (kanbanTasks && kanbanTasks.done && kanbanTasks.done.length) { %>
          <% kanbanTasks.done.forEach(function (t) { %>
            <article
              class="p-3 bg-white rounded-lg shadow-sm border border-gray-200 text-sm cursor-move task-card"
              draggable="true"
              data-task-id="<%= t.id %>"
              data-task-status="done"
              data-project-id="<%= t.project_id || '' %>"
              data-task-title="<%= t.title || t.name || '' %>"
              data-task-project="<%= t.project_name || '' %>"
              data-task-assignee="<%= t.assignee_name || '' %>">
              <h4 class="font-semibold text-gray-800"><%= t.title || t.name %></h4>

              <% if (t.project_name) { %>
                <p class="text-[11px] text-gray-500">
                  Proyecto: <%= t.project_name %>
                </p>
              <% } %>

              <% if (t.assignee_name) { %>
                <p class="text-[11px] text-gray-500">
                  Asignado a: <%= t.assignee_name %>
                </p>
              <% } %>
            </article>
          <% }); %>
        <% } else { %>
          <p class="text-xs text-gray-400 mt-2">
            No hay tareas completadas en la empresa.
          </p>
        <% } %>
      </div>
    </div>

  </div>

  <script>
    // Filtro de tareas en el Kanban ADMIN por proyecto
    (function() {
      const filtroTarea = document.getElementById('filtroTarea');

      if (!filtroTarea) return;

      filtroTarea.addEventListener('change', (e) => {
        const selected = e.target.value;
        const rootSelector = '#adminKanbanView';
        const cards = document.querySelectorAll(`${rootSelector} [data-task-id]`);

        cards.forEach((card) => {
          const cardProjectId = card.getAttribute('data-project-id') || '';

          // 1) Sin filtro: mostrar todo
          if (!selected) {
            card.classList.remove('hidden');
            return;
          }

          // 2) Solo tareas sin proyecto
          if (selected === '__no_project__') {
            if (!cardProjectId) {
              card.classList.remove('hidden');
            } else {
              card.classList.add('hidden');
            }
            return;
          }

          // 3) Filtro por proyecto específico
          if (cardProjectId === selected) {
            card.classList.remove('hidden');
          } else {
            card.classList.add('hidden');
          }
        });
      });
    })();
  </script>
</section>

<!-- MODAL: Registrar / Editar área -->
<div
  id="modalNuevaArea"
  class="fixed inset-0 z-40 hidden items-center justify-center bg-black/40">
  <div class="bg-white rounded-2xl shadow-lg w-full max-w-md mx-4">
    
    <!-- Header -->
    <div class="px-5 py-3 border-b flex justify-between items-center">
      <h3 class="text-base font-semibold text-gray-800">
        Gestión de áreas
      </h3>
      <button
        type="button"
        class="text-gray-500 hover:text-gray-700"
        onclick="toggleModal('modalNuevaArea', false)">
        ✕
      </button>
    </div>

    <!-- Tabs -->
    <div class="px-5 pt-3 border-b flex gap-4 text-sm">
      <button
        id="tabAreaRegistrar"
        type="button"
        class="pb-2 border-b-2 border-[#2E7D32] text-[#2E7D32] font-medium"
        onclick="switchAreaTab('registrar')">
        Registrar área
      </button>
      <button
        id="tabAreaEditar"
        type="button"
        class="pb-2 border-b-2 border-transparent text-gray-500 hover:text-gray-700"
        onclick="switchAreaTab('editar')">
        Editar área
      </button>
    </div>

    <!-- Contenido -->
    <div class="px-5 py-4 text-sm">
      <!-- TAB: REGISTRAR -->
      <div id="tabContentAreaRegistrar" class="space-y-3">
        <form
          id="formNuevaArea"
          class="space-y-3">

          <!-- Nombre del área -->
          <div>
            <label class="block text-xs font-medium text-gray-700 mb-1">Nombre del área</label>
            <input
              type="text"
              name="name"
              class="w-full border rounded-lg px-3 py-2 focus:outline-none focus:ring-1 focus:ring-[#2E7D32]"
              placeholder="Ej: Operaciones"
              required>
          </div>

          <!-- Descripción -->
          <div>
            <label class="block text-xs font-medium text-gray-700 mb-1">Descripción</label>
            <textarea
              name="description"
              rows="2"
              class="w-full border rounded-lg px-3 py-2 focus:outline-none focus:ring-1 focus:ring-[#2E7D32]"
              placeholder="Notas o alcance del área…"></textarea>
          </div>

          <!-- Estado -->
          <div>
            <label class="block text-xs font-medium text-gray-700 mb-1">Estado</label>
            <select
              id="areaStatus"
              name="status"
              class="w-full border rounded-lg px-3 py-2 bg-white focus:outline-none focus:ring-1 focus:ring-[#2E7D32]"
               required>
              <option value="active">Activa</option>
              <option value="inactive">Inactiva</option>
            </select>
          </div>

          <!-- Footer (Registrar) -->
          <div class="flex justify-end gap-2 pt-2">
            <button
              type="button"
              onclick="toggleModal('modalNuevaArea', false)"
              class="px-3 py-1.5 rounded-lg text-xs border text-gray-600 hover:bg-gray-50">
              Cancelar
            </button>
            <button
              type="submit"
              class="px-3 py-1.5 rounded-lg text-xs bg-[#0288D1] text-white hover:bg-[#0277BD]">
              Guardar
            </button>
          </div>
        </form>
      </div>

      <!-- TAB: EDITAR -->
      <div id="tabContentAreaEditar" class="space-y-3 hidden">
        <form
          id="formEditarArea"
          class="space-y-3">
          
          <!-- Selector de área (solo áreas de la empresa actual) -->
          <div>
            <label class="block text-xs font-medium text-gray-700 mb-1">Área a editar</label>
            <select
              id="selectAreaEditar"
              name="area_id"
              class="w-full border rounded-lg px-3 py-2 bg-white focus:outline-none focus:ring-1 focus:ring-[#2E7D32]"
              required>
              <option value="" disabled selected>Seleccionar área…</option>
              <% if (typeof areas !== 'undefined' && areas.length) { %>
                <% areas.forEach(function(area) { %>
                  <option value="<%= area.id %>">
                    <%= area.name %> (<%= area.status === 'active' ? 'Activa' : 'Inactiva' %>)
                  </option>
                <% }) %>
              <% } %>
            </select>
          </div>

          <!-- Nombre del área -->
          <div>
            <label class="block text-xs font-medium text-gray-700 mb-1">Nombre del área</label>
            <input
              type="text"
              id="editarAreaName"
              name="name"
              class="w-full border rounded-lg px-3 py-2 focus:outline-none focus:ring-1 focus:ring-[#2E7D32]"
              placeholder="Ej: Operaciones"
              required>
          </div>

          <!-- Descripción -->
          <div>
            <label class="block text-xs font-medium text-gray-700 mb-1">Descripción</label>
            <textarea
              id="editarAreaDescription"
              name="description"
              rows="2"
              class="w-full border rounded-lg px-3 py-2 focus:outline-none focus:ring-1 focus:ring-[#2E7D32]"
              placeholder="Notas o alcance del área…"></textarea>
          </div>

          <!-- Estado -->
          <div>
            <label class="block text-xs font-medium text-gray-700 mb-1">Estado</label>
            <select
              id="editarAreaStatus"
              name="status"
              class="w-full border rounded-lg px-3 py-2 bg-white focus:outline-none focus:ring-1 focus:ring-[#2E7D32]">
              <option value="active">Activa</option>
              <option value="inactive">Inactiva</option>
            </select>
          </div>

          <!-- Footer (Editar) -->
          <div class="flex justify-end gap-2 pt-2">
            <button
              type="button"
              onclick="toggleModal('modalNuevaArea', false)"
              class="px-3 py-1.5 rounded-lg text-xs border text-gray-600 hover:bg-gray-50">
              Cancelar
            </button>
            <button
              type="submit"
              class="px-3 py-1.5 rounded-lg text-xs bg-[#0288D1] text-white hover:bg-[#0277BD]">
              Guardar cambios
            </button>
          </div>
        </form>
      </div>
    </div>

  </div>
</div>

<!-- MODAL: Registrar / Editar usuario -->
<div
  id="modalNuevoUsuario"
  class="fixed inset-0 z-40 hidden items-center justify-center bg-black/40">
  <div class="bg-white rounded-2xl shadow-lg w-full max-w-md mx-4">
    <!-- Header -->
    <div class="px-5 py-3 border-b flex justify-between items-center">
      <h3 class="text-base font-semibold text-gray-800">
        Gestión de usuarios
      </h3>
      <button
        type="button"
        class="text-gray-500 hover:text-gray-700"
        onclick="toggleModal('modalNuevoUsuario', false)">
        ✕
      </button>
    </div>

    <!-- Tabs -->
    <div class="px-5 pt-3 border-b flex gap-4 text-sm">
      <button
        id="tabUsuarioRegistrar"
        type="button"
        class="pb-2 border-b-2 border-[#2E7D32] text-[#2E7D32] font-medium"
        onclick="switchUsuarioTab('registrar')">
        Registrar usuario
      </button>
      <button
        id="tabUsuarioEditar"
        type="button"
        class="pb-2 border-b-2 border-transparent text-gray-500 hover:text-gray-700"
        onclick="switchUsuarioTab('editar')">
        Editar usuario
      </button>
    </div>

    <!-- Contenido -->
    <div class="px-5 py-4 text-sm">
      <!-- TAB: REGISTRAR -->
      <div id="tabContentUsuarioRegistrar" class="space-y-3">
        <form
          id="formNuevoUsuario"
          class="space-y-3">

          <!-- Nombre -->
          <div>
            <label class="block text-xs font-medium text-gray-700 mb-1">Nombre completo</label>
            <input
              type="text"
              name="name"
              class="w-full border rounded-lg px-3 py-2 focus:outline-none focus:ring-1 focus:ring-[#2E7D32]"
              placeholder="Ej: Juan Pérez"
              required>
          </div>

          <!-- Correo -->
          <div>
            <label class="block text-xs font-medium text-gray-700 mb-1">Correo corporativo</label>
            <input
              type="email"
              name="email"
              class="w-full border rounded-lg px-3 py-2 focus:outline-none focus:ring-1 focus:ring-[#2E7D32]"
              placeholder="usuario@empresa.cl"
              required>
          </div>

          <!-- Teléfono -->
          <div>
            <label class="block text-xs font-medium text-gray-700 mb-1">Teléfono</label>
            <input
              type="text"
              name="telephone"
              class="w-full border rounded-lg px-3 py-2 focus:outline-none focus:ring-1 focus:ring-[#2E7D32]"
              placeholder="+569...">
          </div>

          <!-- Rol / Estado -->
          <div class="grid gap-3 sm:grid-cols-2">
            <div>
              <label class="block text-xs font-medium text-gray-700 mb-1">Rol</label>
              <select
                name="role"
                class="w-full border rounded-lg px-3 py-2 bg-white focus:outline-none focus:ring-1 focus:ring-[#2E7D32]"
                required>
                <!-- Como admin, solo crearás supervisores: el backend fuerza role_id = 3 -->
                <option value="supervisor" selected>Supervisor</option>
              </select>
              <p class="mt-1 text-[11px] text-gray-400">
                * Como Admin, solo puedes registrar usuarios de tipo Supervisor.
                El sistema asigna automáticamente al Admin actual como jefe directo.
              </p>
            </div>
            <div>
              <label class="block text-xs font-medium text-gray-700 mb-1">Estado</label>
              <select
                name="status"
                class="w-full border rounded-lg px-3 py-2 bg-white focus:outline-none focus:ring-1 focus:ring-[#2E7D32]">
                <option value="active">Activo</option>
                <option value="suspended">Suspendido</option>
              </select>
            </div>
          </div>

          <!-- Área -->
          <div>
            <label class="block text-xs font-medium text-gray-700 mb-1">Área (activas)</label>
            <select
              name="area_id"
              class="w-full border rounded-lg px-3 py-2 bg-white focus:outline-none focus:ring-1 focus:ring-[#2E7D32]"
              required>
              <option value="" disabled selected>Seleccionar área…</option>
              <% if (areas && areas.length) { %>
                <% areas.forEach(function(area) { %>
                  <% if (area.status === 'active') { %>
                    <option value="<%= area.id %>"><%= area.name %></option>
                  <% } %>
                <% }) %>
              <% } %>
            </select>
            <p class="mt-1 text-[11px] text-gray-400">
              * El área es obligatoria para crear un supervisor.
            </p>
          </div>

          <!-- Footer Registrar -->
          <div class="flex justify-end gap-2 pt-2">
            <button
              type="button"
              onclick="toggleModal('modalNuevoUsuario', false)"
              class="px-3 py-1.5 rounded-lg text-xs border text-gray-600 hover:bg-gray-50">
              Cancelar
            </button>
            <button
              type="submit"
              class="px-3 py-1.5 rounded-lg text-xs bg-[#2E7D32] text-white hover:bg-[#1B5E20]">
              Guardar
            </button>
          </div>
        </form>
      </div>

      <!-- TAB: EDITAR -->
      <div id="tabContentUsuarioEditar" class="space-y-3 hidden">
        <form
          id="formEditarUsuario"
          class="space-y-3">

          <!-- Selector de usuario -->
          <div>
            <label class="block text-xs font-medium text-gray-700 mb-1">
              Usuario a editar
            </label>
            <select
              id="selectUsuarioEditar"
              name="user_id"
              class="w-full border rounded-lg px-3 py-2 bg-white focus:outline-none focus:ring-1 focus:ring-[#2E7D32]"
              required>
              <option value="">Seleccionar usuario…</option>
              <!-- Las opciones se cargan vía JS (/api/users) -->
            </select>
            <p class="mt-1 text-[11px] text-gray-400">
              * Solo verás usuarios de la empresa actual.
            </p>
          </div>

          <!-- Nombre -->
          <div>
            <label class="block text-xs font-medium text-gray-700 mb-1">
              Nombre completo
            </label>
            <input
              type="text"
              id="editarUsuarioName"
              name="name"
              class="w-full border rounded-lg px-3 py-2 focus:outline-none focus:ring-1 focus:ring-[#2E7D32]"
              required>
          </div>

          <!-- Correo -->
          <div>
            <label class="block text-xs font-medium text-gray-700 mb-1">
              Correo corporativo
            </label>
            <input
              type="email"
              id="editarUsuarioEmail"
              name="email"
              class="w-full border rounded-lg px-3 py-2 focus:outline-none focus:ring-1 focus:ring-[#2E7D32]"
              required>
          </div>

          <!-- Teléfono -->
          <div>
            <label class="block text-xs font-medium text-gray-700 mb-1">
              Teléfono
            </label>
            <input
              type="text"
              id="editarUsuarioTelephone"
              name="telephone"
              class="w-full border rounded-lg px-3 py-2 focus:outline-none focus:ring-1 focus:ring-[#2E7D32]">
          </div>

          <!-- Rol / Estado -->
          <div class="grid grid-cols-1 md:grid-cols-2 gap-3">
            <div>
              <label class="block text-xs font-medium text-gray-700 mb-1">
                Rol
              </label>
              <select
                id="editarUsuarioRole"
                name="role"
                class="w-full border rounded-lg px-3 py-2 bg-white focus:outline-none focus:ring-1 focus:ring-[#2E7D32]">
                <option value="admin">Administrador</option>
                <option value="supervisor">Supervisor</option>
                <option value="user">Usuario</option>
              </select>
            </div>
            <div>
              <label class="block text-xs font-medium text-gray-700 mb-1">
                Estado
              </label>
              <select
                id="editarUsuarioStatus"
                name="status"
                class="w-full border rounded-lg px-3 py-2 bg-white focus:outline-none focus:ring-1 focus:ring-[#2E7D32]">
                <option value="active">Activo</option>
                <option value="suspended">Suspendido</option>
              </select>
            </div>
          </div>

          <!-- Área -->
          <div>
            <label class="block text-xs font-medium text-gray-700 mb-1">
              Área (activas)
            </label>
            <select
              id="editarUsuarioArea"
              name="area_id"
              class="w-full border rounded-lg px-3 py-2 bg-white focus:outline-none focus:ring-1 focus:ring-[#2E7D32]">
              <option value="">Sin área asignada</option>
              <% if (areas && areas.length) { %>
                <% areas.forEach(function(area) { %>
                  <% if (area.status === 'active') { %>
                    <option value="<%= area.id %>"><%= area.name %></option>
                  <% } %>
                <% }) %>
              <% } %>
            </select>
          </div>

          <!-- Footer editar -->
          <div class="flex justify-end gap-2 pt-2">

            <!-- Resetear contraseña a la genérica -->
            <button
              type="button"
              onclick="resetPasswordUsuarioSupervisor()"
              class="px-3 py-1.5 rounded-lg text-xs border border-amber-400 text-amber-600 hover:bg-amber-50">
              Reset pass genérica
            </button>
            <button
              type="button"
              onclick="toggleModal('modalNuevoUsuario', false)"
              class="px-3 py-1.5 rounded-lg text-xs border text-gray-600 hover:bg-gray-50">
              Cancelar
            </button>
            <button
              type="submit"
              class="px-3 py-1.5 rounded-lg text-xs bg-[#0288D1] text-white hover:bg-[#0277BD]">
              Guardar cambios
            </button>
          </div>
        </form>
      </div>
    </div>

  </div>
</div>

<!-- MODAL: Registrar / Editar grupo de trabajo (TEAM) -->
<div
  id="modalNuevoGrupo"
  class="fixed inset-0 z-40 hidden items-center justify-center bg-black/40">
  <div class="bg-white rounded-2xl shadow-lg w-full max-w-md mx-4">
    <!-- Header -->
    <div class="px-5 py-3 border-b flex justify-between items-center">
      <h3 class="text-base font-semibold text-gray-800">
        Gestión de grupos de trabajo
      </h3>
      <button
        type="button"
        class="text-gray-500 hover:text-gray-700"
        onclick="toggleModal('modalNuevoGrupo', false)">
        ✕
      </button>
    </div>

    <!-- Tabs -->
    <div class="px-5 pt-3 border-b flex gap-4 text-sm">
      <button
        id="tabTeamRegistrar"
        type="button"
        class="pb-2 border-b-2 border-[#7B1FA2] text-[#7B1FA2] font-medium"
        onclick="switchTeamTab('registrar')">
        Registrar grupo
      </button>
      <button
        id="tabTeamEditar"
        type="button"
        class="pb-2 border-b-2 border-transparent text-gray-500 hover:text-gray-700"
        onclick="switchTeamTab('editar')">
        Editar grupo
      </button>
    </div>

    <!-- Contenido -->
    <div class="px-5 py-4 text-sm">
      <!-- TAB: REGISTRAR -->
      <div id="tabContentTeamRegistrar" class="space-y-3">
        <form
          id="formNuevoGrupo"
          class="space-y-3">

          <!-- Nombre del grupo -->
          <div>
            <label class="block text-xs font-medium text-gray-700 mb-1">
              Nombre del grupo de trabajo
            </label>
            <input
              type="text"
              name="name"
              class="w-full border rounded-lg px-3 py-2 focus:outline-none focus:ring-1 focus:ring-[#7B1FA2]"
              placeholder="Ej: Proyecto ERP Planta, Comité Seguridad, Turno Mixto Noche"
              required>
          </div>

          <!-- Tipo / Estado -->
          <div class="grid gap-3 sm:grid-cols-2">
            <div>
              <label class="block text-xs font-medium text-gray-700 mb-1">
                Tipo de grupo
              </label>
              <select
                name="type"
                class="w-full border rounded-lg px-3 py-2 bg-white focus:outline-none focus:ring-1 focus:ring-[#7B1FA2]">
                <option value="" disabled selected>Seleccionar…</option>
                <option value="area_team">Equipo de área</option>
                <option value="project">Proyecto puntual</option>
                <option value="committee">Comité permanente</option>
                <option value="shift">Turno / cuadrilla</option>
                <option value="other">Otro</option>
              </select>
            </div>
            <div>
              <label class="block text-xs font-medium text-gray-700 mb-1">
                Estado
              </label>
              <select
                name="status"
                class="w-full border rounded-lg px-3 py-2 bg-white focus:outline-none focus:ring-1 focus:ring-[#7B1FA2]">
                <option value="active">Activo</option>
                <option value="paused">Pausado</option>
                <option value="closed">Cerrado</option>
              </select>
            </div>
          </div>

          <!-- Descripción -->
          <div>
            <label class="block text-xs font-medium text-gray-700 mb-1">
              Descripción / alcance
            </label>
            <textarea
              name="description"
              rows="2"
              class="w-full border rounded-lg px-3 py-2 focus:outline-none focus:ring-1 focus:ring-[#7B1FA2]"
              placeholder="Ej: Grupo transversal para coordinar tareas entre Operaciones, Calidad y TI."></textarea>
          </div>

          <!-- Footer -->
          <div class="flex justify-end gap-2 pt-2">
            <button
              type="button"
              onclick="toggleModal('modalNuevoGrupo', false)"
              class="px-3 py-1.5 rounded-lg text-xs border text-gray-600 hover:bg-gray-50">
              Cancelar
            </button>
            <button
              type="submit"
              class="px-3 py-1.5 rounded-lg text-xs bg-[#7B1FA2] text-white hover:bg-[#6A1B9A]">
              Guardar
            </button>
          </div>
        </form>
      </div>

      <!-- TAB: EDITAR -->
      <div id="tabContentTeamEditar" class="space-y-3 hidden">
        <form
          id="formEditarTeam"
          class="space-y-3">

          <!-- Selector de grupo -->
          <div>
            <label class="block text-xs font-medium text-gray-700 mb-1">
              Grupo de trabajo a editar
            </label>
            <select
              id="selectTeamEditar"
              name="team_id"
              class="w-full border rounded-lg px-3 py-2 bg-white focus:outline-none focus:ring-1 focus:ring-[#7B1FA2]"
              required>
              <option value="" disabled selected>Seleccionar grupo…</option>
              <!-- Se rellena vía JS con /api/teams -->
            </select>
          </div>

          <!-- Nombre -->
          <div>
            <label class="block text-xs font-medium text-gray-700 mb-1">
              Nombre del grupo
            </label>
            <input
              type="text"
              id="editarTeamName"
              name="name"
              class="w-full border rounded-lg px-3 py-2 focus:outline-none focus:ring-1 focus:ring-[#7B1FA2]"
              required>
          </div>

          <!-- Tipo / Estado -->
          <div class="grid gap-3 sm:grid-cols-2">
            <div>
              <label class="block text-xs font-medium text-gray-700 mb-1">
                Tipo de grupo
              </label>
              <select
                id="editarTeamType"
                name="type"
                class="w-full border rounded-lg px-3 py-2 bg-white focus:outline-none focus:ring-1 focus:ring-[#7B1FA2]">
                <option value="area_team">Equipo de área</option>
                <option value="project">Proyecto puntual</option>
                <option value="committee">Comité permanente</option>
                <option value="shift">Turno / cuadrilla</option>
                <option value="other">Otro</option>
              </select>
            </div>
            <div>
              <label class="block text-xs font-medium text-gray-700 mb-1">
                Estado
              </label>
              <select
                id="editarTeamStatus"
                name="status"
                class="w-full border rounded-lg px-3 py-2 bg-white focus:outline-none focus:ring-1 focus:ring-[#7B1FA2]">
                <option value="active">Activo</option>
                <option value="paused">Pausado</option>
                <option value="closed">Cerrado</option>
              </select>
            </div>
          </div>

          <!-- Descripción -->
          <div>
            <label class="block text-xs font-medium text-gray-700 mb-1">
              Descripción / alcance
            </label>
            <textarea
              id="editarTeamDescription"
              name="description"
              rows="2"
              class="w-full border rounded-lg px-3 py-2 focus:outline-none focus:ring-1 focus:ring-[#7B1FA2]"
              placeholder="Descripción del grupo…"></textarea>
          </div>

          <!-- Footer -->
          <div class="flex justify-end gap-2 pt-2">
            <button
              type="button"
              onclick="toggleModal('modalNuevoGrupo', false)"
              class="px-3 py-1.5 rounded-lg text-xs border text-gray-600 hover:bg-gray-50">
              Cancelar
            </button>
            <button
              type="submit"
              class="px-3 py-1.5 rounded-lg text-xs bg-[#7B1FA2] text-white hover:bg-[#6A1B9A]">
              Guardar cambios
            </button>
          </div>
        </form>
      </div>
    </div>

  </div>
</div>

<!-- MODAL: Editar miembros de grupo -->
<div
  id="modalEditarGrupo"
  class="fixed inset-0 z-40 hidden items-center justify-center bg-black/40">
  <div class="bg-white rounded-2xl shadow-lg w-full max-w-3xl mx-4">
    <!-- Header -->
    <div class="px-5 py-3 border-b flex justify-between items-center">
      <h3 class="text-base font-semibold text-gray-800">
        Editar miembros del grupo
      </h3>
      <button
        type="button"
        class="text-gray-500 hover:text-gray-700"
        onclick="toggleModal('modalEditarGrupo', false)">
        ✕
      </button>
    </div>

    <!-- Body -->
    <div class="px-5 py-4 space-y-4 text-sm">
      <!-- Selección de grupo -->
      <div class="grid gap-3 sm:grid-cols-3 items-end">
        <div class="sm:col-span-2">
          <label class="block text-xs font-medium text-gray-700 mb-1">
            Grupo de trabajo
          </label>
          <select
            id="grupoSeleccionado"
            class="w-full border rounded-lg px-3 py-2 bg-white focus:outline-none focus:ring-1 focus:ring-[#7B1FA2]">
            <option value="" disabled selected>Seleccionar grupo…</option>
            <!-- Opciones desde backend (teams) -->
          </select>
        </div>
        <div class="flex gap-2 justify-end">
          <button
            id="btnRefrescarGrupo"
            type="button"
            class="px-3 py-1.5 rounded-lg text-xs border text-gray-600 hover:bg-gray-50">
            Refrescar
          </button>
        </div>
      </div>

      <!-- Filtros de usuarios -->
      <div class="grid gap-3 sm:grid-cols-3">
        <div>
          <label class="block text-xs font-medium text-gray-700 mb-1">
            Área
          </label>
          <select
            id="filtroArea"
            class="w-full border rounded-lg px-3 py-2 bg-white focus:outline-none focus:ring-1 focus:ring-[#7B1FA2]">
            <option value="">Todas las áreas…</option>
            <% if (typeof areas !== 'undefined' && areas.length) { %>
              <% areas.forEach(function(area) { %>
                <% if (area.status === 'active') { %>
                  <option value="<%= area.id %>"><%= area.name %></option>
                <% } %>
              <% }) %>
            <% } %>
          </select>
        </div>
        <div>
          <label class="block text-xs font-medium text-gray-700 mb-1">
            Tipo de usuario
          </label>
          <select
            id="filtroTipoUsuario"
            class="w-full border rounded-lg px-3 py-2 bg-white focus:outline-none focus:ring-1 focus:ring-[#7B1FA2]">
            <option value="">Supervisores y trabajadores</option>
            <option value="supervisor">Solo supervisores</option>
            <option value="user">Solo trabajadores</option>
          </select>
        </div>
        <div>
          <label class="block text-xs font-medium text-gray-700 mb-1">
            Buscar por nombre
          </label>
          <input
            type="text"
            id="buscadorUsuarioGrupo"
            class="w-full border rounded-lg px-3 py-2 focus:outline-none focus:ring-1 focus:ring-[#7B1FA2]"
            placeholder="Ej: Diego, Juan, etc.">
        </div>
      </div>

      <!-- Listas de usuarios -->
      <div class="grid gap-4 sm:grid-cols-2">
        <!-- Disponibles -->
        <div>
          <h4 class="text-xs font-semibold text-gray-700 mb-2">
            Usuarios disponibles
            <span class="text-[11px] text-gray-400 block">
              (Supervisores y trabajadores de la empresa)
            </span>
          </h4>
          <div class="border rounded-lg h-56 overflow-y-auto">
            <ul id="listaUsuariosDisponibles" class="divide-y text-xs">
              <!-- Ejemplo estático -->
              <li class="flex items-center justify-between px-3 py-2 hover:bg-gray-50">
                <div>
                  <p class="font-medium text-gray-800">Juan Soto</p>
                  <p class="text-[11px] text-gray-500">Supervisor · Operaciones</p>
                </div>
                <button
                  type="submit"
                  class="text-[11px] px-2 py-1 rounded border border-[#7B1FA2] text-[#7B1FA2] hover:bg-[#F3E5F5]">
                  Agregar
                </button>
              </li>
              <!-- luego se rellena dinámico -->
            </ul>
          </div>
        </div>

        <!-- Miembros del grupo -->
        <div>
          <h4 class="text-xs font-semibold text-gray-700 mb-2">
            Miembros del grupo
            <span class="text-[11px] text-gray-400 block">
              (Supervisores y trabajadores actualmente asignados)
            </span>
          </h4>
          <div class="border rounded-lg h-56 overflow-y-auto">
            <ul id="listaMiembrosGrupo" class="divide-y text-xs">
              <!-- Ejemplo estático -->
              <li class="flex items-center justify-between px-3 py-2 hover:bg-gray-50">
                <div>
                  <p class="font-medium text-gray-800">María Rojas</p>
                  <p class="text-[11px] text-gray-500">Trabajadora · Mantenimiento</p>
                </div>
                <button
                  type="submit"
                  class="text-[11px] px-2 py-1 rounded border border-red-400 text-red-500 hover:bg-red-50">
                  Quitar
                </button>
              </li>
              <!-- luego se rellena dinámico -->
            </ul>
          </div>
        </div>
      </div>
    </div>

    <!-- Footer -->
    <div class="px-5 py-3 border-t flex justify-end gap-2">
      <button
        type="button"
        onclick="toggleModal('modalEditarGrupo', false)"
        class="px-3 py-1.5 rounded-lg text-xs border text-gray-600 hover:bg-gray-50">
        Cerrar
      </button>
      <button
        id="btnGuardarMiembrosGrupo"
        type="button"
        class="px-3 py-1.5 rounded-lg text-xs bg-[#7B1FA2] text-white hover:bg-[#6A1B9A]">
        Guardar cambios
      </button>
    </div>
  </div>
</div>

<!-- Helpers JS mínimos para los modals -->
<script>
  function handleAdminQuickAction(selectEl) {
    const value = selectEl.value;
    if (!value) return;

    if (value === 'nuevoUsuario') {
      toggleModal('modalNuevoUsuario', true);
    }
    if (value === 'nuevaArea') {
      toggleModal('modalNuevaArea', true);
    }
    if (value === 'nuevoGrupo') {
      toggleModal('modalNuevoGrupo', true);
    }
    if (value === 'editarGrupo') {
      toggleModal('modalEditarGrupo', true);
    }

    // reset del select
    selectEl.value = '';
  }
</script>

<!-- Script: Control de pestañas para registrar / editar áreas -->
<script>
  function switchAreaTab(tab) {
    const tabRegistrar = document.getElementById('tabAreaRegistrar');
    const tabEditar = document.getElementById('tabAreaEditar');
    const contentRegistrar = document.getElementById('tabContentAreaRegistrar');
    const contentEditar = document.getElementById('tabContentAreaEditar');

    if (tab === 'registrar') {
      tabRegistrar.classList.add('border-[#2E7D32]', 'text-[#2E7D32]');
      tabRegistrar.classList.remove('border-transparent', 'text-gray-500');
      tabEditar.classList.add('border-transparent', 'text-gray-500');
      tabEditar.classList.remove('border-[#2E7D32]', 'text-[#2E7D32]');

      contentRegistrar.classList.remove('hidden');
      contentEditar.classList.add('hidden');
    } else {
      tabEditar.classList.add('border-[#2E7D32]', 'text-[#2E7D32]');
      tabEditar.classList.remove('border-transparent', 'text-gray-500');
      tabRegistrar.classList.add('border-transparent', 'text-gray-500');
      tabRegistrar.classList.remove('border-[#2E7D32]', 'text-[#2E7D32]');

      contentEditar.classList.remove('hidden');
      contentRegistrar.classList.add('hidden');
    }
  }
</script>

<!-- Función: Editar áreas (flujo completo) -->
<script>
  const selectAreaEditar = document.getElementById('selectAreaEditar');
  const formEditarArea = document.getElementById('formEditarArea');
  const inputEditarName = document.getElementById('editarAreaName');
  const inputEditarDesc = document.getElementById('editarAreaDescription');
  const selectEditarStatus = document.getElementById('editarAreaStatus');

  if (selectAreaEditar && formEditarArea) {
    // 1) Cuando se elije un área del combo, se cargan sus datos desde la API
    selectAreaEditar.addEventListener('change', async () => {
      const id = selectAreaEditar.value;
      if (!id) return;

      try {
        const res = await fetch(`/api/areas/${id}`, {
          credentials: 'same-origin'
        });
        const data = await res.json();

        if (!data.ok) {
          alert(data.message || 'No se pudo cargar el área');
          return;
        }

        const area = data.data;
        inputEditarName.value = area.name || '';
        inputEditarDesc.value = area.description || '';
        selectEditarStatus.value = area.status || 'active';
      } catch (err) {
        console.error(err);
        alert('Error al cargar el área');
      }
    });

    // 2) Al enviar el formulario, se mandan los cambios a /api/areas/:id/edit
    formEditarArea.addEventListener('submit', async (e) => {
      e.preventDefault();
      const id = selectAreaEditar.value;

      if (!id) {
        alert('Selecciona un área primero');
        return;
      }

      try {
        const body = new URLSearchParams(new FormData(formEditarArea));

        const res = await fetch(`/api/areas/${id}/edit`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/x-www-form-urlencoded;charset=UTF-8'
          },
          body,
          credentials: 'same-origin'
        });

        const data = await res.json();
        alert(data.message || 'Cambios guardados');

        if (data.ok) {
          // se recarga para ver los cambios reflejados en la UI
          window.location.reload();
        }
      } catch (err) {
        console.error(err);
        alert('Error al actualizar el área');
      }
    });
  }
</script>

<!-- Script: Control de pestañas para registrar / editar usuarios -->
<script>
  function switchUsuarioTab(tab) {
    const tabRegistrar = document.getElementById('tabUsuarioRegistrar');
    const tabEditar = document.getElementById('tabUsuarioEditar');
    const contentRegistrar = document.getElementById('tabContentUsuarioRegistrar');
    const contentEditar = document.getElementById('tabContentUsuarioEditar');

    if (tab === 'registrar') {
      tabRegistrar.classList.add('border-[#2E7D32]', 'text-[#2E7D32]');
      tabRegistrar.classList.remove('border-transparent', 'text-gray-500');
      tabEditar.classList.add('border-transparent', 'text-gray-500');
      tabEditar.classList.remove('border-[#2E7D32]', 'text-[#2E7D32]');

      contentRegistrar.classList.remove('hidden');
      contentEditar.classList.add('hidden');
    } else {
      tabEditar.classList.add('border-[#2E7D32]', 'text-[#2E7D32]');
      tabEditar.classList.remove('border-transparent', 'text-gray-500');
      tabRegistrar.classList.add('border-transparent', 'text-gray-500');
      tabRegistrar.classList.remove('border-[#2E7D32]', 'text-[#2E7D32]');

      contentEditar.classList.remove('hidden');
      contentRegistrar.classList.add('hidden');
    }
  }
</script>

<!-- Función: Editar usuarios -->
<script>
  const selectUsuarioEditar = document.getElementById('selectUsuarioEditar');
  const formEditarUsuario = document.getElementById('formEditarUsuario');

  const inputUsuarioName = document.getElementById('editarUsuarioName');
  const inputUsuarioEmail = document.getElementById('editarUsuarioEmail');
  const inputUsuarioTel = document.getElementById('editarUsuarioTelephone');
  const selectUsuarioRole = document.getElementById('editarUsuarioRole');
  const selectUsuarioStatus = document.getElementById('editarUsuarioStatus');
  const selectUsuarioArea = document.getElementById('editarUsuarioArea');
  const selectUsuarioManager = document.getElementById('editarUsuarioManager');

  async function cargarUsuariosParaEditar() {
    try {
      const res = await fetch('/api/users', { credentials: 'same-origin' });
      const data = await res.json();

      if (!data.ok || !Array.isArray(data.data)) {
        alert(data.message || 'No se pudieron cargar los usuarios');
        return;
      }

      if (!selectUsuarioEditar) return;

      // Limpiar opciones actuales (menos el placeholder)
      while (selectUsuarioEditar.options.length > 1) {
        selectUsuarioEditar.remove(1);
      }

      // Solo mostrar SUPERVISORES (role_id = 3) para edición por Admin
      data.data
        .filter(u => u.role_id === 3)
        .forEach((u) => {
          const opt = document.createElement('option');
          opt.value = u.id;
          opt.textContent = `${u.name} (${u.email})`;
          selectUsuarioEditar.appendChild(opt);
        });
    } catch (err) {
      console.error(err);
      alert('Error al cargar usuarios');
    }
  }

  if (selectUsuarioEditar && formEditarUsuario) {
    // Cargamos lista de usuarios al abrir la vista
    cargarUsuariosParaEditar();

    // Cuando se selecciona un usuario, traemos sus datos
    selectUsuarioEditar.addEventListener('change', async () => {
      const id = selectUsuarioEditar.value;
      if (!id) return;

      try {
        const res = await fetch(`/api/users/${id}`, {
          credentials: 'same-origin'
        });
        const data = await res.json();

        if (!data.ok || !data.data) {
          alert(data.message || 'No se pudo cargar el usuario');
          return;
        }

        const u = data.data || {};

        // Campos básicos
        if (inputUsuarioName) {
          inputUsuarioName.value = u.name || '';
        }
        if (inputUsuarioEmail) {
          inputUsuarioEmail.value = u.email || '';
        }
        if (inputUsuarioTel) {
          inputUsuarioTel.value = u.telephone || '';
        }

        // Rol (informativo: en Admin siempre debería ser supervisor)
        if (selectUsuarioRole) {
          if (u.role_id === 2) selectUsuarioRole.value = 'admin';
          else if (u.role_id === 3) selectUsuarioRole.value = 'supervisor';
          else selectUsuarioRole.value = 'user';
        }

        // Estado
        if (selectUsuarioStatus) {
          selectUsuarioStatus.value = u.status || 'active';
        }

        // Área
        if (selectUsuarioArea) {
          if (u.area_id) {
            selectUsuarioArea.value = String(u.area_id);
          } else {
            selectUsuarioArea.value = '';
          }
        }

        // Jefe directo (solo informativo en UI; backend forzará manager_id = admin)
        if (selectUsuarioManager) {
          if (u.manager_id) {
            selectUsuarioManager.value = String(u.manager_id);
          } else {
            selectUsuarioManager.value = '';
          }
        }
      } catch (err) {
        console.error(err);
        alert('Error al cargar el usuario');
      }
    });

    // Enviar cambios
    formEditarUsuario.addEventListener('submit', async (e) => {
      e.preventDefault();
      const id = selectUsuarioEditar.value;

      if (!id) {
        alert('Selecciona un usuario primero');
        return;
      }

      try {
        const body = new URLSearchParams(new FormData(formEditarUsuario));

        const res = await fetch(`/api/users/${id}/edit`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/x-www-form-urlencoded;charset=UTF-8'
          },
          body,
          credentials: 'same-origin'
        });

        const data = await res.json();
        alert(data.message || 'Cambios guardados');

        if (data.ok) {
          window.location.reload();
        }
      } catch (err) {
        console.error(err);
        alert('Error al actualizar el usuario');
      }
    });
  }

  async function resetPasswordUsuarioAdmin() {
    if (!selectUsuarioEditar) {
      alert('No se encontró el selector de usuarios.');
      return;
    }

    const id = selectUsuarioEditar.value;
    if (!id) {
      alert('Selecciona un usuario primero.');
      return;
    }

    const confirmar = confirm(
      '¿Seguro que deseas resetear la contraseña de este usuario ' +
      'a la contraseña genérica del sistema?'
    );
    if (!confirmar) return;

    try {
      const res = await fetch(`/api/users/${id}/reset-password`, {
        method: 'POST',
        headers: {
          'Content-Type': 'application/x-www-form-urlencoded;charset=UTF-8'
        },
        credentials: 'same-origin'
      });

      const data = await res.json();
      alert(data.message || 'Operación realizada.');
    } catch (err) {
      console.error(err);
      alert('Error al resetear la contraseña.');
    }
  }
</script>

<!-- Función: Editar teams -->
<script>
  // Tabs pestañas registrar / editar
  function switchTeamTab(tab) {
    const tabRegistrar = document.getElementById('tabTeamRegistrar');
    const tabEditar = document.getElementById('tabTeamEditar');
    const contentRegistrar = document.getElementById('tabContentTeamRegistrar');
    const contentEditar = document.getElementById('tabContentTeamEditar');

    if (!tabRegistrar || !tabEditar || !contentRegistrar || !contentEditar) return;

    if (tab === 'registrar') {
      tabRegistrar.classList.add('border-[#7B1FA2]', 'text-[#7B1FA2]');
      tabRegistrar.classList.remove('border-transparent', 'text-gray-500');
      tabEditar.classList.add('border-transparent', 'text-gray-500');
      tabEditar.classList.remove('border-[#7B1FA2]', 'text-[#7B1FA2]');

      contentRegistrar.classList.remove('hidden');
      contentEditar.classList.add('hidden');
    } else {
      tabEditar.classList.add('border-[#7B1FA2]', 'text-[#7B1FA2]');
      tabEditar.classList.remove('border-transparent', 'text-gray-500');
      tabRegistrar.classList.add('border-transparent', 'text-gray-500');
      tabRegistrar.classList.remove('border-[#7B1FA2]', 'text-[#7B1FA2]');

      contentEditar.classList.remove('hidden');
      contentRegistrar.classList.add('hidden');
    }
  }

  // Exponerla para que main.js la pueda usar en toggleModal
  window.switchTeamTab = switchTeamTab;

  // ===============================
  // EDITAR TEAM (datos básicos)
  // ===============================
  const selectTeamEditar = document.getElementById('selectTeamEditar');
  const formEditarTeam = document.getElementById('formEditarTeam');

  const inputTeamName = document.getElementById('editarTeamName');
  const selectTeamType = document.getElementById('editarTeamType');
  const selectTeamStatus = document.getElementById('editarTeamStatus');
  const inputTeamDescription = document.getElementById('editarTeamDescription');

  async function cargarTeamsParaEditar() {
    if (!selectTeamEditar) return;

    try {
      const res = await fetch('/api/teams', { credentials: 'same-origin' });
      const data = await res.json();

      if (!data.ok || !Array.isArray(data.data)) {
        console.warn(data.message || 'No se pudieron cargar los grupos');
        return;
      }

      while (selectTeamEditar.options.length > 1) {
        selectTeamEditar.remove(1);
      }

      data.data.forEach((t) => {
        const opt = document.createElement('option');
        opt.value = t.id;
        opt.textContent = `${t.name} (${t.status})`;
        selectTeamEditar.appendChild(opt);
      });
    } catch (err) {
      console.error('Error cargarTeamsParaEditar:', err);
    }
  }

  if (selectTeamEditar && formEditarTeam) {
    cargarTeamsParaEditar();

    selectTeamEditar.addEventListener('change', async () => {
      const id = selectTeamEditar.value;
      if (!id) return;

      try {
        const res = await fetch(`/api/teams/${id}`, {
          credentials: 'same-origin'
        });
        const data = await res.json();

        if (!data.ok || !data.data) {
          alert(data.message || 'No se pudo cargar el grupo');
          return;
        }

        const t = data.data;

        if (inputTeamName) inputTeamName.value = t.name || '';
        if (inputTeamDescription) inputTeamDescription.value = t.description || '';
        if (selectTeamType) selectTeamType.value = t.type || 'other';
        if (selectTeamStatus) selectTeamStatus.value = t.status || 'active';
      } catch (err) {
        console.error('Error al cargar team:', err);
        alert('Error al cargar el grupo de trabajo');
      }
    });

    formEditarTeam.addEventListener('submit', async (e) => {
      e.preventDefault();
      const id = selectTeamEditar.value;
      if (!id) {
        alert('Selecciona un grupo primero');
        return;
      }

      try {
        const body = new URLSearchParams(new FormData(formEditarTeam));

        const res = await fetch(`/api/teams/${id}/edit`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/x-www-form-urlencoded;charset=UTF-8'
          },
          body,
          credentials: 'same-origin'
        });

        const data = await res.json();
        alert(data.message || 'Cambios guardados');

        if (data.ok) {
          window.location.reload();
        }
      } catch (err) {
        console.error('Error al actualizar team:', err);
        alert('Error al actualizar el grupo de trabajo');
      }
    });
  }
</script>

<!-- Función: Configurar teams -->
<script>
  // ===============================
  // EDICIÓN DE GRUPOS (miembros)
  // ===============================

  // IDs de áreas activas (inyectadas desde el servidor)
  window.activeAreaIds = <%- JSON.stringify(
    (typeof areas !== 'undefined' && Array.isArray(areas)
      ? areas
          .filter(function (a) { return a.status === 'active'; })
          .map(function (a) { return a.id; })
      : []
    )
  ) %>;

  const selectGrupo = document.getElementById('grupoSeleccionado');
  const btnRefrescarGrupo = document.querySelector('#modalEditarGrupo btnRefrescarGrupo');
  const filtroArea = document.getElementById('filtroArea');
  const filtroTipoUsuario = document.getElementById('filtroTipoUsuario');
  const buscadorUsuarioGrupo = document.getElementById('buscadorUsuarioGrupo');

  const listaUsuariosDisponibles = document.getElementById('listaUsuariosDisponibles');
  const listaMiembrosGrupo = document.getElementById('listaMiembrosGrupo');

  let todosUsuariosGrupo = [];
  let miembrosActualesGrupo = [];

  // Cargar teams para el select
  async function cargarGruposTrabajo() {
    if (!selectGrupo) return;

    try {
      const res = await fetch('/api/teams', { credentials: 'same-origin' });
      const data = await res.json();

      if (!data.ok || !Array.isArray(data.data)) {
        console.warn(data.message || 'No se pudieron cargar los grupos');
        return;
      }

      // Limpiar (dejar solo el placeholder)
      while (selectGrupo.options.length > 1) {
        selectGrupo.remove(1);
      }

    // 🔹 Solo teams activos
    data.data
      .filter((t) => t.status === 'active')
      .forEach((t) => {
        const opt = document.createElement('option');
        opt.value = t.id;
        // puedes dejar solo el nombre, porque ya son todos activos
        opt.textContent = t.name;
        selectGrupo.appendChild(opt);
      });
    } catch (err) {
      console.error('Error cargarGruposTrabajo:', err);
    }
  }

  // Cargar usuarios base para lista de disponibles (supervisores + workers)
// Cargar usuarios base para lista de disponibles (supervisores + workers)
  async function cargarUsuariosBaseGrupo() {
    try {
      const res = await fetch('/api/users', { credentials: 'same-origin' });
      const data = await res.json();

      if (!data.ok || !Array.isArray(data.data)) {
        console.warn(data.message || 'No se pudieron cargar los usuarios');
        return;
      }

      let usuarios = data.data;

      // 🔹 1) Solo usuarios activos
      usuarios = usuarios.filter((u) => u.status === 'active');

      // 🔹 2) Solo usuarios en áreas activas (o sin área)
      const activosSet = new Set(
        (window.activeAreaIds || []).map((id) => String(id))
      );

      usuarios = usuarios.filter((u) => {
        if (!u.area_id) return true; // usuarios sin área, los dejamos
        return activosSet.has(String(u.area_id));
      });

      // Guardamos todos los usuarios filtrados
      todosUsuariosGrupo = usuarios;
      renderListasGrupo();
    } catch (err) {
      console.error('Error cargarUsuariosBaseGrupo:', err);
    }
  }

  // Cargar miembros actuales del team seleccionado
  async function cargarMiembrosGrupo() {
    const teamId = selectGrupo?.value;
    if (!teamId) return;

    try {
      const res = await fetch(`/api/teams/${teamId}/members`, {
        credentials: 'same-origin'
      });
      const data = await res.json();

      if (!data.ok || !Array.isArray(data.data)) {
        console.warn(data.message || 'No se pudieron cargar los miembros');
        return;
      }

      miembrosActualesGrupo = data.data;
      renderListasGrupo();
    } catch (err) {
      console.error('Error cargarMiembrosGrupo:', err);
    }
  }

  // Helpers para filtros
  function pasaFiltrosUsuario(u) {
    // Filtro por área
    if (filtroArea && filtroArea.value) {
      if (String(u.area_id || '') !== filtroArea.value) return false;
    }

    // Filtro tipo usuario (role_id)
    if (filtroTipoUsuario && filtroTipoUsuario.value) {
      if (filtroTipoUsuario.value === 'supervisor' && u.role_id !== 3) {
        return false;
      }
      if (filtroTipoUsuario.value === 'user' && u.role_id !== 4) {
        return false;
      }
    }

    // Filtro por texto
    if (buscadorUsuarioGrupo && buscadorUsuarioGrupo.value.trim()) {
      const term = buscadorUsuarioGrupo.value.trim().toLowerCase();
      const nombre = (u.name || '').toLowerCase();
      const correo = (u.email || '').toLowerCase();
      if (!nombre.includes(term) && !correo.includes(term)) {
        return false;
      }
    }

    return true;
  }

  function renderListasGrupo() {
    if (!listaUsuariosDisponibles || !listaMiembrosGrupo) return;

    const teamId = selectGrupo?.value;
    const idsMiembros = new Set(miembrosActualesGrupo.map((m) => m.user_id));

    // Disponibles = todos - miembros
    const disponibles = todosUsuariosGrupo.filter(
      (u) => !idsMiembros.has(u.id) && pasaFiltrosUsuario(u)
    );

    // Limpiar ULs
    listaUsuariosDisponibles.innerHTML = '';
    listaMiembrosGrupo.innerHTML = '';

    // Render disponibles
    if (!teamId) {
      // Si no hay grupo seleccionado, mostramos mensaje base
      listaUsuariosDisponibles.innerHTML = `
        <li class="px-3 py-2 text-[11px] text-gray-500">
          Selecciona un grupo para comenzar.
        </li>`;
      listaMiembrosGrupo.innerHTML = `
        <li class="px-3 py-2 text-[11px] text-gray-500">
          Selecciona un grupo para ver sus miembros.
        </li>`;
      return;
    }

    if (!disponibles.length) {
      listaUsuariosDisponibles.innerHTML = `
        <li class="px-3 py-2 text-[11px] text-gray-500">
          No hay usuarios disponibles con los filtros actuales.
        </li>`;
    } else {
      disponibles.forEach((u) => {
        const li = document.createElement('li');
        li.className = 'flex items-center justify-between px-3 py-2 hover:bg-gray-50';
        li.innerHTML = `
          <div>
            <p class="font-medium text-gray-800">${u.name}</p>
            <p class="text-[11px] text-gray-500">
              ${u.email} · ${u.area_name || ''} 
            </p>
          </div>
          <button
            type="button"
            class="text-[11px] px-2 py-1 rounded border border-[#7B1FA2] text-[#7B1FA2] hover:bg-[#F3E5F5]"
            data-user-id="${u.id}"
          >
            Agregar
          </button>
        `;
        listaUsuariosDisponibles.appendChild(li);
      });
    }

    // Render miembros
    if (!miembrosActualesGrupo.length) {
      listaMiembrosGrupo.innerHTML = `
        <li class="px-3 py-2 text-[11px] text-gray-500">
          Este grupo aún no tiene miembros.
        </li>`;
    } else {
      miembrosActualesGrupo.forEach((m) => {
        const li = document.createElement('li');
        li.className = 'flex items-center justify-between px-3 py-2 hover:bg-gray-50';
        li.innerHTML = `
          <div>
            <p class="font-medium text-gray-800">${m.name}</p>
            <p class="text-[11px] text-gray-500">
              ${m.email} · ${m.role_in_team === 'leader' ? 'Líder' : 'Miembro'}
            </p>
          </div>
          <button
            type="button"
            class="text-[11px] px-2 py-1 rounded border border-red-400 text-red-500 hover:bg-red-50"
            data-user-id="${m.user_id}"
          >
            Quitar
          </button>
        `;
        listaMiembrosGrupo.appendChild(li);
      });
    }

    // Delegación de eventos para Agregar / Quitar
    listaUsuariosDisponibles.onclick = async (ev) => {
      const btn = ev.target.closest('button[data-user-id]');
      if (!btn) return;
      const userId = btn.getAttribute('data-user-id');
      await agregarMiembroGrupo(teamId, userId);
    };

    listaMiembrosGrupo.onclick = async (ev) => {
      const btn = ev.target.closest('button[data-user-id]');
      if (!btn) return;
      const userId = btn.getAttribute('data-user-id');
      await quitarMiembroGrupo(teamId, userId);
    };
  }

  async function agregarMiembroGrupo(teamId, userId) {
    if (!teamId || !userId) return;
    try {
      const body = new URLSearchParams({ user_id: userId });
      const res = await fetch(`/api/teams/${teamId}/members/add`, {
        method: 'POST',
        headers: {
          'Content-Type': 'application/x-www-form-urlencoded;charset=UTF-8'
        },
        body,
        credentials: 'same-origin'
      });
      const data = await res.json();
      alert(data.message || 'Operación realizada');

      if (data.ok && Array.isArray(data.data)) {
        miembrosActualesGrupo = data.data;
        renderListasGrupo();
      }
    } catch (err) {
      console.error('Error agregarMiembroGrupo:', err);
      alert('Error al agregar miembro');
    }
  }

  async function quitarMiembroGrupo(teamId, userId) {
    if (!teamId || !userId) return;
    try {
      const body = new URLSearchParams({ user_id: userId });
      const res = await fetch(`/api/teams/${teamId}/members/remove`, {
        method: 'POST',
        headers: {
          'Content-Type': 'application/x-www-form-urlencoded;charset=UTF-8'
        },
        body,
        credentials: 'same-origin'
      });
      const data = await res.json();
      alert(data.message || 'Operación realizada');

      if (data.ok && Array.isArray(data.data)) {
        miembrosActualesGrupo = data.data;
        renderListasGrupo();
      }
    } catch (err) {
      console.error('Error quitarMiembroGrupo:', err);
      alert('Error al quitar miembro');
    }
  }

  // Inicialización al cargar la vista admin
  document.addEventListener('DOMContentLoaded', () => {
    if (!document.getElementById('modalEditarGrupo')) return;

    cargarGruposTrabajo();
    cargarUsuariosBaseGrupo();

    if (selectGrupo) {
      selectGrupo.addEventListener('change', () => {
        cargarMiembrosGrupo();
      });
    }

    if (filtroArea) {
      filtroArea.addEventListener('change', renderListasGrupo);
    }
    if (filtroTipoUsuario) {
      filtroTipoUsuario.addEventListener('change', renderListasGrupo);
    }
    if (buscadorUsuarioGrupo) {
      buscadorUsuarioGrupo.addEventListener('input', () => {
        // un pequeño debounce sería nice, pero por ahora directo:
        renderListasGrupo();
      });
    }

    // Botón refrescar
    const btnRefrescarGrupo = document.getElementById('btnRefrescarGrupo');
    if (btnRefrescarGrupo) {
      btnRefrescarGrupo.addEventListener('click', async () => {
        btnRefrescarGrupo.disabled = true;

        // helper local para mostrar mensaje con notify o alert de respaldo
        const showMsg = (ok, message) => {
          if (typeof notify === 'function') {
            notify({ ok, message });
          } else {
            alert(message);
          }
        };

        try {
          await Promise.all([
            cargarGruposTrabajo(),
            cargarUsuariosBaseGrupo(),
            cargarMiembrosGrupo()
          ]);

          showMsg(true, 'Grupos, usuarios y miembros actualizados desde el servidor.');
        } catch (err) {
          console.error('Error al refrescar grupo:', err);
          showMsg(false, 'Ocurrió un error al refrescar los datos del grupo.');
        } finally {
          btnRefrescarGrupo.disabled = false;
        }
      });
    }

    // Botón "Guardar cambios"
    const btnGuardarMiembrosGrupo = document.getElementById('btnGuardarMiembrosGrupo');
    if (btnGuardarMiembrosGrupo) {
      btnGuardarMiembrosGrupo.addEventListener('click', () => {
        // Opcional: algún mensaje suave
        alert('Los cambios de miembros ya se guardan cada vez que agregas o quitas.\nCerraré el modal.');
        toggleModal('modalEditarGrupo', false);
      });
    }
  });
</script>

<!-- MODAL: Crear nueva tarea (Admin) -->
<div
  id=""
  class="fixed inset-0 z-40 hidden items-center justify-center bg-black/40">
  <div class="bg-white rounded-2xl shadow-lg w-full max-w-xl mx-4">
    <!-- Header -->
    <div class="px-5 py-3 border-b flex justify-between items-center">
      <h3 class="text-base font-semibold text-gray-800">
        Nueva tarea
      </h3>
      <button
        type="button"
        class="text-gray-500 hover:text-gray-700"
        onclick="toggleModal('modalNuevaTarea', false)">
        ✕
      </button>
    </div>

    <!-- Body -->
    <div class="px-5 py-4 text-sm">
      <form id="formNuevaTarea" class="space-y-4">
        <!-- PROYECTO (opcional) -->
        <div>
          <label class="block text-xs font-medium text-gray-700 mb-1">
            Proyecto (opcional)
          </label>
          <select
            id="taskProject"
            name="project_id"
            class="w-full border rounded-lg px-3 py-2 bg-white focus:outline-none focus:ring-1 focus:ring-[#7B1FA2]">
            <option value="">Sin proyecto asociado</option>
            <% if (typeof projects !== 'undefined' && Array.isArray(projects) && projects.length) { %>
              <% projects.forEach(function (p) { %>
                <option value="<%= p.id %>">
                  <%= p.name %>
                </option>
              <% }) %>
            <% } %>
          </select>
        </div>

        <!-- TÍTULO + PRIORIDAD -->
        <div class="grid gap-3 sm:grid-cols-3 items-start">
          <div class="sm:col-span-2">
            <label class="block text-xs font-medium text-gray-700 mb-1">
              Título de la tarea
            </label>
            <input
              type="text"
              name="title"
              class="w-full border rounded-lg px-3 py-2 focus:outline-none focus:ring-1 focus:ring-[#7B1FA2]"
              placeholder="Ej: Revisar reporte de ventas, Coordinar reunión de equipo"
              required>
          </div>

          <div>
            <label class="block text-xs font-medium text-gray-700 mb-1">
              Prioridad
            </label>
            <select
              name="priority"
              class="w-full border rounded-lg px-3 py-2 bg-white focus:outline-none focus:ring-1 focus:ring-[#7B1FA2]"
              required>
              <option value="low">Baja</option>
              <option value="normal" selected>Media</option>
              <option value="high">Alta</option>
              <option value="critical">Crítica</option>
            </select>
          </div>
        </div>

        <!-- DESCRIPCIÓN -->
        <div>
          <label class="block text-xs font-medium text-gray-700 mb-1">
            Descripción / detalle
          </label>
          <textarea
            name="description"
            rows="2"
            class="w-full border rounded-lg px-3 py-2 focus:outline-none focus:ring-1 focus:ring-[#7B1FA2]"
            placeholder="Agrega contexto, links o notas relevantes (opcional)"></textarea>
        </div>

        <!-- FECHA LÍMITE -->
        <div class="grid gap-3 sm:grid-cols-2">
          <div>
            <label class="block text-xs font-medium text-gray-700 mb-1">
              Fecha límite (opcional)
            </label>
            <input
              type="date"
              id="taskDeadlineDate"
              name="deadline_date"
              class="w-full border rounded-lg px-3 py-2 focus:outline-none focus:ring-1 focus:ring-[#7B1FA2]">
          </div>
          <div>
            <label class="block text-xs font-medium text-gray-700 mb-1">
              Hora (opcional)
            </label>
            <input
              type="time"
              id="taskDeadlineTime"
              name="deadline_time"
              class="w-full border rounded-lg px-3 py-2 focus:outline-none focus:ring-1 focus:ring-[#7B1FA2]">
          </div>
        </div>

        <!-- ASIGNACIÓN: usuarios (admin ve toda la compañía) -->
        <div class="border-t pt-3 mt-2 space-y-2">
          <label class="block text-xs font-medium text-gray-700 mb-1">
            Asignar a uno o varios usuarios
          </label>

          <select
            id="taskAssignees"
            name="assignees[]"
            multiple
            size="3"
            class="w-full border rounded-lg px-3 py-2 bg-white focus:outline-none focus:ring-1 focus:ring-[#7B1FA2]"
            required>
            <% if (typeof users !== 'undefined' && Array.isArray(users)) { %>
              <% users.forEach(function (u) { %>
                <% if (u.status === 'active') { %>
                  <option value="<%= u.id %>">
                    <%= u.name %>
                    <% if (user && u.id === user.id) { %> · Yo <% } %>
                    <% if (u.area_name) { %> · <%= u.area_name %> <% } %>
                  </option>
                <% } %>
              <% }) %>
            <% } %>
          </select>

          <p class="text-[11px] text-gray-400">
            Mantén Ctrl / Cmd presionado para seleccionar varios usuarios.
          </p>

          <div class="flex flex-wrap gap-2 mt-1">
            <button
              type="button"
              class="px-2 py-1 rounded-lg text-[11px] border text-gray-700 hover:bg-gray-100"
              onclick="seleccionarTodaMiArea()">
              Seleccionar todo
            </button>
            <button
              type="button"
              class="px-2 py-1 rounded-lg text-[11px] border text-gray-700 hover:bg-gray-100"
              onclick="seleccionarSoloYo()">
              Solo yo
            </button>
            <button
              type="button"
              class="px-2 py-1 rounded-lg text-[11px] border text-gray-500 hover:bg-gray-100"
              onclick="limpiarSeleccionArea()">
              Limpiar selección
            </button>
            <div>
              <select
                name="priority"
                class="w-full border rounded-lg px-3 py-2 bg-white focus:outline-none focus:ring-1 focus:ring-[#7B1FA2]"
                required>
                <option value="low">Baja</option>
                <option value="normal" selected>Media</option>
                <option value="high">Alta</option>
                <option value="critical">Crítica</option>
              </select>
            </div>
        </div>

        <!-- Hidden: status inicial (pending) -->
        <input type="hidden" name="status" value="pending">
      </form>
    </div>

    <!-- Footer -->
    <div class="px-5 py-3 border-t flex justify-end gap-2">
      <button
        type="button"
        class="px-3 py-1.5 rounded-lg border text-sm text-gray-600 hover:bg-gray-50"
        onclick="toggleModal('modalNuevaTarea', false)">
        Cancelar
      </button>
      <button
        id="btnGuardarNuevaTarea"
        type="submit"
        form="formNuevaTarea"
        class="px-3 py-1.5 rounded-lg bg-[#2E7D32] text-white text-sm hover:bg-[#1B5E20]">
        Guardar tarea
      </button>
    </div>
  </div>
</div>

<!-- Scripts de ayuda para asignar tareas -->
<script>
  function seleccionarTodaMiArea() {
    const sel = document.getElementById('taskAssignees');
    if (!sel) return;
    for (const opt of sel.options) {
      opt.selected = true;
    }
  }

  function seleccionarSoloYo() {
    const sel = document.getElementById('taskAssignees');
    if (!sel) return;

    const currentId = String(window.currentUserId || '');
    for (const opt of sel.options) {
      opt.selected = (opt.value === currentId);
    }
  }

  function limpiarSeleccionArea() {
    const sel = document.getElementById('taskAssignees');
    if (!sel) return;
    for (const opt of sel.options) {
      opt.selected = false;
    }
  }
</script>

<!-- MODAL: Commits de tarea (vista usuario) -->
<div
  id="modalTaskCommit"
  class="fixed inset-0 z-50 hidden items-center justify-center bg-black/40"
>
  <div
    class="bg-white rounded-2xl shadow-xl max-w-4xl w-full mx-4 max-h-[90vh] flex flex-col"
  >
    <!-- Header -->
    <header class="px-6 py-4 border-b flex items-center justify-between">
      <div>
        <p class="text-xs uppercase tracking-wide text-gray-400">
          Commits de tarea
        </p>
        <h3
          id="commitTaskTitle"
          class="text-lg font-semibold text-gray-900 truncate"
        >
          <!-- Título de la tarea -->
        </h3>
        <div class="mt-1 flex items-center gap-2 text-xs text-gray-500">
          <span class="inline-flex items-center gap-1">
            <span class="material-icons text-base">assignment</span>
            <span id="commitTaskIdLabel">Tarea #</span>
          </span>
          <span class="inline-flex items-center gap-1">
            <span class="material-icons text-base">label</span>
            <span
              id="commitTaskStatusBadge"
              class="inline-flex items-center px-2 py-0.5 rounded-full text-xs bg-gray-100 text-gray-700"
            >
              <!-- Estado en texto -->
            </span>
          </span>
        </div>
      </div>

      <button
        type="button"
        class="p-2 rounded-full hover:bg-gray-100 text-gray-500"
        onclick="toggleModal('modalTaskCommit', false)"
      >
        <span class="material-icons">close</span>
      </button>
    </header>

    <!-- Body -->
    <div class="flex-1 overflow-hidden px-6 py-4">
      <div class="grid gap-6 md:grid-cols-2 h-full">
        <!-- Historial de commits -->
        <section class="flex flex-col h-full">
          <div class="flex items-center justify-between mb-2">
            <h4 class="text-sm font-semibold text-gray-800">
              Historial de commits
            </h4>
          </div>

          <div
            id="commitList"
            class="flex-1 max-h-64 md:max-h-80 overflow-y-auto pr-2 space-y-3 text-sm border rounded-xl p-3 bg-gray-50"
          >
            <p class="text-xs text-gray-400">
              Aún no hay commits registrados para esta tarea.
            </p>
          </div>
        </section>

        <!-- Nuevo commit -->
        <section class="flex flex-col h-full">
          <h4 class="text-sm font-semibold text-gray-800 mb-2">
            Nuevo commit
          </h4>

          <form
            id="formNuevoCommit"
            class="flex flex-col h-full gap-3"
          >
            <!-- IDs ocultos -->
            <input type="hidden" id="commitTaskId" name="task_id">
            <input type="hidden" id="commitFromStatus" name="from_status">

            <!-- Mensaje -->
            <div class="flex-1 flex flex-col">
              <label
                for="commitMessage"
                class="text-xs font-medium text-gray-600 mb-1"
              >
                Descripción del avance / bloqueo / instrucción
              </label>
              <textarea
                id="commitMessage"
                name="message"
                rows="6"
                class="flex-1 w-full rounded-lg border border-gray-300 text-sm px-3 py-2 resize-none focus:outline-none focus:ring-2 focus:ring-[#2E7D32]/60 focus:border-[#2E7D32]"
                placeholder="Ej: Avancé con la carga de datos de facturas, queda pendiente validar los totales con contabilidad..."
                required
              ></textarea>
              <p class="mt-1 text-[11px] text-gray-400">
                Piensa este commit como un mini &quot;git commit&quot;: qué hiciste,
                qué falta, qué bloqueos tienes, qué instrucciones seguiste, etc.
              </p>
            </div>

            <!-- Cambio de estado (opcional) -->
            <div class="grid grid-cols-1 gap-2 md:grid-cols-2">
              <div>
                <label
                  for="commitToStatus"
                  class="text-xs font-medium text-gray-600 mb-1"
                >
                  Cambiar estado de la tarea (opcional)
                </label>
                <select
                  id="commitToStatus"
                  name="to_status"
                  class="w-full rounded-lg border border-gray-300 text-sm px-2 py-2 bg-white focus:outline-none focus:ring-2 focus:ring-[#2E7D32]/60 focus:border-[#2E7D32]"
                >
                  <option value="">Mantener estado actual</option>
                  <option value="pending">Pendiente</option>
                  <option value="in_progress">En progreso</option>
                  <option value="review">En revisión</option>
                  <option value="done">Completada</option>
                </select>
              </div>

              <div class="text-xs text-gray-500 md:text-[11px]">
                <p class="mb-1 font-medium">Recomendación:</p>
                <ul class="list-disc list-inside space-y-0.5">
                  <li><strong>Pendiente → En progreso</strong> cuando comiences.</li>
                  <li><strong>En progreso → En revisión</strong> cuando la des por lista.</li>
                  <li><strong>En revisión → Completada</strong> normalmente lo hará tu supervisor.</li>
                </ul>
              </div>
            </div>

            <!-- Footer botones -->
            <div class="flex justify-end gap-2 pt-2 border-t mt-1">
              <button
                type="button"
                class="px-4 py-2 rounded-lg border text-sm text-gray-600 hover:bg-gray-100"
                onclick="toggleModal('modalTaskCommit', false)"
              >
                Cancelar
              </button>
              <button
                type="submit"
                class="px-4 py-2 rounded-lg text-sm bg-[#2E7D32] text-white hover:bg-[#1B5E20]"
              >
                Guardar commit
              </button>
            </div>
          </form>
        </section>
      </div>
    </div>
  </div>
</div>

<!-- Script reset password -->
<script>
      // 4) Resetear contraseña a la genérica (solo trabajadores a cargo)
    async function resetPasswordUsuarioSupervisor() {
      if (!selectUsuarioEditar) {
        alert('No se encontró el selector de usuarios.');
        return;
      }

      const id = selectUsuarioEditar.value;
      if (!id) {
        alert('Selecciona un usuario primero.');
        return;
      }

      const confirmar = confirm(
        '¿Seguro que deseas resetear la contraseña de este usuario ' +
        'a la contraseña genérica del sistema?'
      );
      if (!confirmar) return;

      try {
        const res = await fetch(`/api/users/${id}/reset-password`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/x-www-form-urlencoded;charset=UTF-8'
          },
          credentials: 'same-origin'
        });

        const data = await res.json();
        alert(data.message || 'Operación realizada.');
      } catch (err) {
        console.error(err);
        alert('Error al resetear la contraseña.');
      }
    }

    // Exponer función al scope global para usarla en onclick
    window.resetPasswordUsuarioSupervisor = resetPasswordUsuarioSupervisor;
</script>


