<!-- Navbar personalizada admin -->
<nav class="bg-white shadow">
  <div class="max-w-7xl mx-auto px-4 py-3 flex justify-between items-center">

    <!-- Izquierda: logo más bienvenida -->
    <a href="javascript:void(0)" class="flex items-center gap-2">
      <img src="/img/logo.png" alt="TasksFlow" class="h-16 w-auto">
      <span class="font-semibold text-lg text-[#2E7D32] hidden sm:inline">
        <%= user ? user.name : 'TasksFlow' %>
      </span>
    </a>

    <!-- Derecha: botones modales y vista kanban -->
    <div class="flex items-center gap-3">

      <!-- Botón: nueva área de trabajo -->
      <button 
        type="button"
        onclick="toggleModal('modalNuevaArea', true)"
        class="hidden sm:inline-flex items-center gap-1 px-3 py-1 rounded-lg bg-[#0288D1] text-white text-sm hover:bg-[#0277BD]">
        <span class="material-symbols-outlined text-sm">add</span>
        <span>área</span>
        <span class="material-symbols-outlined text-sm">edit</span>
      </button>

      <!-- Botón: registrar usuario -->
       <button 
          type="button"
          onclick="toggleModal('modalNuevoUsuario', true)"
          class="hidden sm:inline-flex items-center gap-1 px-3 py-1 rounded-lg bg-[#2E7D32] text-white text-sm hover:bg-[#1B5E20]">
          <span class="material-symbols-outlined text-sm">add</span>
          <span>usuario</span>
          <span class="material-symbols-outlined text-sm">edit</span>
        </button>

      <!-- Botón: Nuevo team (grupo de trabajo) -->
      <button
        type="button"
        onclick="toggleModal('modalNuevoGrupo', true)"
        class="hidden sm:inline-flex items-center gap-1 px-3 py-1 rounded-lg bg-[#7B1FA2] text-white text-sm hover:bg-[#6A1B9A]">
        <span class="material-symbols-outlined text-sm">add</span>
        <span>team</span>
      </button>

      <!-- Botón: Editar team (grupo de trabajo) -->
    <button
      type="button"
      onclick="toggleModal('modalEditarGrupo', true)"
      class="hidden sm:inline-flex items-center gap-1 px-3 py-1 rounded-lg bg-[#0284C7] text-white text-sm hover:bg-[#0369A1]">
      <span class="material-symbols-outlined text-sm">edit</span>
      <span>team</span>
    </button>

      <!-- Menú simple para móviles -->
      <div class="sm:hidden">
        <select
          class="border rounded-lg px-2 py-1 text-sm"
          onchange="handleAdminQuickAction(this)">
          <option value="">Acciones</option>
          <option value="nuevoUsuario">Nuevo usuario</option>
          <option value="nuevaArea">Nueva área/equipo</option>
          <option value="nuevoGrupo">Nuevo grupo de trabajo</option>
        </select>
      </div>

      <!-- Toggle vista Kanban -->
      <label
        id="kanbanToggleLabel"
        class="inline-flex items-center gap-1 px-3 py-1 rounded-lg border text-sm cursor-pointer bg-white text-gray-700 hover:bg-[#E8F5E9]">
        <input
          id="kanbanToggle"
          type="checkbox"
          class="sr-only"
          onchange="toggleKanbanView(this)">
        <span class="material-icons text-base">view_module</span>
        <span>Kanban</span>
      </label>

      <!-- Logout -->
      <a href="/logout"
        onclick="return doLogout()"
        class="px-3 py-1 rounded-lg bg-[#F87171] text-white hover:bg-[#EF4444] text-sm">
        Logout
      </a>
    </div>
  </div>
</nav>

<!-- Vista DASHBOARD (por defecto visible) -->
<section id="adminDashboardView" class="max-w-6xl mx-auto my-8">
  <!-- Título -->
  <div class="bg-white rounded-2xl p-6 shadow mb-6">
    <h2 class="text-2xl font-semibold text-[#2E7D32] mb-1">Panel Admin</h2>
    <p class="text-sm text-gray-600">
      Control y monitoreo general de áreas, equipos y tareas.
    </p>
  </div>

  <!-- Tarjetas resumen -->
  <div class="grid gap-4 md:grid-cols-4 mb-6">
    <div class="bg-white p-4 rounded-2xl shadow">
      <p class="text-xs uppercase tracking-wide text-gray-500">Áreas activas</p>
      <p class="text-3xl font-semibold text-[#2E7D32] mt-1">4</p>
      <p class="text-xs text-gray-500 mt-1">Operaciones, Calidad, TI, RRHH</p>
    </div>

    <div class="bg-white p-4 rounded-2xl shadow">
      <p class="text-xs uppercase tracking-wide text-gray-500">Equipos</p>
      <p class="text-3xl font-semibold text-[#0288D1] mt-1">9</p>
      <p class="text-xs text-gray-500 mt-1">Incluye turnos y células de trabajo</p>
    </div>

    <div class="bg-white p-4 rounded-2xl shadow">
      <p class="text-xs uppercase tracking-wide text-gray-500">Usuarios activos</p>
      <p class="text-3xl font-semibold text-[#F9A825] mt-1">27</p>
      <p class="text-xs text-gray-500 mt-1">Con acceso al sistema</p>
    </div>

    <div class="bg-white p-4 rounded-2xl shadow">
      <p class="text-xs uppercase tracking-wide text-gray-500">Tareas abiertas</p>
      <p class="text-3xl font-semibold text-[#E64A19] mt-1">18</p>
      <p class="text-xs text-gray-500 mt-1">Pendientes (To Do + In Progress)</p>
    </div>
  </div>

  <!-- Grilla principal: Áreas/Equipos - Tareas -->
  <div class="grid gap-6 md:grid-cols-2">
    <!-- Panel Áreas y equipos -->
    <div class="bg-white rounded-2xl shadow p-4">
      <div class="flex items-center justify-between mb-3">
        <h3 class="text-lg font-semibold text-gray-800">Áreas y equipos</h3>
        <button
          type="button"
          onclick="toggleModal('modalNuevaArea', true)"
          class="text-xs px-2 py-1 rounded-lg border border-[#0288D1] text-[#0288D1] hover:bg-[#E1F5FE]">
          + Nueva área/equipo
        </button>
      </div>

      <div class="overflow-x-auto">
        <table class="min-w-full text-sm">
          <thead>
            <tr class="text-left text-gray-500 border-b text-xs uppercase">
              <th class="py-2 pr-3">Área</th>
              <th class="py-2 pr-3">Equipo / Grupo</th>
              <th class="py-2 pr-3">Usuarios</th>
              <th class="py-2">Tareas abiertas</th>
            </tr>
          </thead>
          <tbody class="divide-y text-xs sm:text-sm">
            <tr>
              <td class="py-2 pr-3 font-medium text-gray-800">Operaciones</td>
              <td class="py-2 pr-3">Turno Noche Planta</td>
              <td class="py-2 pr-3">8</td>
              <td class="py-2 text-[#E64A19] font-semibold">5</td>
            </tr>
            <tr>
              <td class="py-2 pr-3 font-medium text-gray-800">Operaciones</td>
              <td class="py-2 pr-3">Turno Día Despacho</td>
              <td class="py-2 pr-3">5</td>
              <td class="py-2 text-[#E64A19] font-semibold">3</td>
            </tr>
            <tr>
              <td class="py-2 pr-3 font-medium text-gray-800">Calidad</td>
              <td class="py-2 pr-3">Control de proceso</td>
              <td class="py-2 pr-3">4</td>
              <td class="py-2 text-[#F9A825] font-semibold">4</td>
            </tr>
            <tr>
              <td class="py-2 pr-3 font-medium text-gray-800">TI</td>
              <td class="py-2 pr-3">Soporte interno</td>
              <td class="py-2 pr-3">3</td>
              <td class="py-2 text-[#2E7D32] font-semibold">1</td>
            </tr>
          </tbody>
        </table>
      </div>
    </div>

    <!-- Panel Tareas recientes -->
    <div class="bg-white rounded-2xl shadow p-4">
      <div class="flex items-center justify-between mb-3">
        <h3 class="text-lg font-semibold text-gray-800">Tareas recientes</h3>
        <span class="text-xs text-gray-500">Últimas actualizaciones</span>
      </div>

      <div class="overflow-x-auto">
        <table class="min-w-full text-sm">
          <thead>
            <tr class="text-left text-gray-500 border-b text-xs uppercase">
              <th class="py-2 pr-3">Tarea</th>
              <th class="py-2 pr-3">Asignado a</th>
              <th class="py-2 pr-3">Estado</th>
              <th class="py-2">Área</th>
            </tr>
          </thead>
          <tbody class="divide-y text-xs sm:text-sm">
            <tr>
              <td class="py-2 pr-3 font-medium text-gray-800">Ajuste turnos torniquetes</td>
              <td class="py-2 pr-3">Juan Soto</td>
              <td class="py-2 pr-3">
                <span class="px-2 py-0.5 rounded-full bg-[#FFF3E0] text-[#E64A19] text-[11px] font-semibold">
                  In Progress
                </span>
              </td>
              <td class="py-2">Operaciones</td>
            </tr>
            <tr>
              <td class="py-2 pr-3 font-medium text-gray-800">Revisión checklist calidad</td>
              <td class="py-2 pr-3">María Rojas</td>
              <td class="py-2 pr-3">
                <span class="px-2 py-0.5 rounded-full bg-[#FFFDE7] text-[#F9A825] text-[11px] font-semibold">
                  To Do
                </span>
              </td>
              <td class="py-2">Calidad</td>
            </tr>
            <tr>
              <td class="py-2 pr-3 font-medium text-gray-800">Actualizar DSN satélites VB6</td>
              <td class="py-2 pr-3">Diego A.</td>
              <td class="py-2 pr-3">
                <span class="px-2 py-0.5 rounded-full bg-[#E8F5E9] text-[#2E7D32] text-[11px] font-semibold">
                  Done
                </span>
              </td>
              <td class="py-2">TI</td>
            </tr>
            <tr>
              <td class="py-2 pr-3 font-medium text-gray-800">Capacitación nuevo supervisor</td>
              <td class="py-2 pr-3">Carolina V.</td>
              <td class="py-2 pr-3">
                <span class="px-2 py-0.5 rounded-full bg-[#FFFDE7] text-[#F9A825] text-[11px] font-semibold">
                  To Do
                </span>
              </td>
              <td class="py-2">RRHH</td>
            </tr>
          </tbody>
        </table>
      </div>
    </div>
  </div>

  <!-- Panel de monitoreo rápido (opcional) -->
  <div class="mt-6 bg-white rounded-2xl shadow p-4">
    <div class="flex items-center justify-between mb-3">
      <h3 class="text-lg font-semibold text-gray-800">Monitoreo rápido</h3>
      <span class="text-xs text-gray-500">Vista general del día</span>
    </div>
    <div class="grid gap-4 md:grid-cols-3 text-xs sm:text-sm">
      <div>
        <p class="text-gray-500 mb-1">Tareas por estado</p>
        <ul class="space-y-1">
          <li class="flex justify-between">
            <span>To Do</span>
            <span class="font-semibold text-[#F9A825]">9</span>
          </li>
          <li class="flex justify-between">
            <span>In Progress</span>
            <span class="font-semibold text-[#E64A19]">6</span>
          </li>
          <li class="flex justify-between">
            <span>Done (hoy)</span>
            <span class="font-semibold text-[#2E7D32]">3</span>
          </li>
        </ul>
      </div>
      <div>
        <p class="text-gray-500 mb-1">Áreas con más carga</p>
        <ul class="space-y-1">
          <li>Operaciones · <span class="font-semibold">8 tareas</span></li>
          <li>Calidad · <span class="font-semibold">4 tareas</span></li>
          <li>TI · <span class="font-semibold">3 tareas</span></li>
        </ul>
      </div>
      <div>
        <p class="text-gray-500 mb-1">Observaciones</p>
        <ul class="space-y-1">
          <li>✔ Revisión de DSN completada en TI</li>
          <li>⚠ Alta carga en turno noche planta</li>
          <li>ℹ Pendiente capacitación supervisor nuevo</li>
        </ul>
      </div>
    </div>
  </div>
</section>

<!-- Vista KANBAN (por ahora solo H1, oculta al inicio) -->
<section id="adminKanbanView" class="max-w-6xl mx-auto my-8 hidden">
  <div class="bg-white rounded-2xl p-6 shadow mb-6">
    <h1 class="text-3xl font-semibold text-[#2E7D32] mb-2">
      Vista Kanban · Bienvenido
    </h1>
    <p class="text-sm text-gray-600">
      Aquí verás el tablero Kanban de TasksFlow para administrar áreas, equipos y tareas en columnas (To Do, In Progress, Done).
    </p>
  </div>

  <!-- Aquí después podrás montar las columnas Kanban reales -->
</section>

<!-- MODAL: Registrar / Editar área (empresa actual) -->
<div
  id="modalNuevaArea"
  class="fixed inset-0 z-40 hidden items-center justify-center bg-black/40">
  <div class="bg-white rounded-2xl shadow-lg w-full max-w-md mx-4">
    
    <!-- Header -->
    <div class="px-5 py-3 border-b flex justify-between items-center">
      <h3 class="text-base font-semibold text-gray-800">
        Gestión de áreas
      </h3>
      <button
        type="button"
        class="text-gray-500 hover:text-gray-700"
        onclick="toggleModal('modalNuevaArea', false)">
        ✕
      </button>
    </div>

    <!-- Tabs -->
    <div class="px-5 pt-3 border-b flex gap-4 text-sm">
      <button
        id="tabAreaRegistrar"
        type="button"
        class="pb-2 border-b-2 border-[#2E7D32] text-[#2E7D32] font-medium"
        onclick="switchAreaTab('registrar')">
        Registrar área
      </button>
      <button
        id="tabAreaEditar"
        type="button"
        class="pb-2 border-b-2 border-transparent text-gray-500 hover:text-gray-700"
        onclick="switchAreaTab('editar')">
        Editar área
      </button>
    </div>

    <!-- Contenido -->
    <div class="px-5 py-4 text-sm">
      <!-- TAB: REGISTRAR -->
      <div id="tabContentAreaRegistrar" class="space-y-3">
        <form
          id="formNuevaArea"
          class="space-y-3">

          <!-- Nombre del área -->
          <div>
            <label class="block text-xs font-medium text-gray-700 mb-1">Nombre del área</label>
            <input
              type="text"
              name="name"
              class="w-full border rounded-lg px-3 py-2 focus:outline-none focus:ring-1 focus:ring-[#2E7D32]"
              placeholder="Ej: Operaciones"
              required>
          </div>

          <!-- Descripción -->
          <div>
            <label class="block text-xs font-medium text-gray-700 mb-1">Descripción</label>
            <textarea
              name="description"
              rows="2"
              class="w-full border rounded-lg px-3 py-2 focus:outline-none focus:ring-1 focus:ring-[#2E7D32]"
              placeholder="Notas o alcance del área…"></textarea>
          </div>

          <!-- Estado -->
          <div>
            <label class="block text-xs font-medium text-gray-700 mb-1">Estado</label>
            <select
              id="areaStatus"
              name="status"
              class="w-full border rounded-lg px-3 py-2 bg-white focus:outline-none focus:ring-1 focus:ring-[#2E7D32]"
               required>
              <option value="active">Activa</option>
              <option value="inactive">Inactiva</option>
            </select>
          </div>

          <!-- Footer (Registrar) -->
          <div class="flex justify-end gap-2 pt-2">
            <button
              type="button"
              onclick="toggleModal('modalNuevaArea', false)"
              class="px-3 py-1.5 rounded-lg text-xs border text-gray-600 hover:bg-gray-50">
              Cancelar
            </button>
            <button
              type="submit"
              class="px-3 py-1.5 rounded-lg text-xs bg-[#0288D1] text-white hover:bg-[#0277BD]">
              Guardar
            </button>
          </div>
        </form>
      </div>

      <!-- TAB: EDITAR -->
      <div id="tabContentAreaEditar" class="space-y-3 hidden">
        <form
          id="formEditarArea"
          class="space-y-3">
          
          <!-- Selector de área (solo áreas de la empresa actual) -->
          <div>
            <label class="block text-xs font-medium text-gray-700 mb-1">Área a editar</label>
            <select
              id="selectAreaEditar"
              name="area_id"
              class="w-full border rounded-lg px-3 py-2 bg-white focus:outline-none focus:ring-1 focus:ring-[#2E7D32]"
              required>
              <option value="" disabled selected>Seleccionar área…</option>
              <% if (typeof areas !== 'undefined' && areas.length) { %>
                <% areas.forEach(function(area) { %>
                  <option value="<%= area.id %>">
                    <%= area.name %> (<%= area.status === 'active' ? 'Activa' : 'Inactiva' %>)
                  </option>
                <% }) %>
              <% } %>
            </select>
          </div>

          <!-- Nombre del área -->
          <div>
            <label class="block text-xs font-medium text-gray-700 mb-1">Nombre del área</label>
            <input
              type="text"
              id="editarAreaName"
              name="name"
              class="w-full border rounded-lg px-3 py-2 focus:outline-none focus:ring-1 focus:ring-[#2E7D32]"
              placeholder="Ej: Operaciones"
              required>
          </div>

          <!-- Descripción -->
          <div>
            <label class="block text-xs font-medium text-gray-700 mb-1">Descripción</label>
            <textarea
              id="editarAreaDescription"
              name="description"
              rows="2"
              class="w-full border rounded-lg px-3 py-2 focus:outline-none focus:ring-1 focus:ring-[#2E7D32]"
              placeholder="Notas o alcance del área…"></textarea>
          </div>

          <!-- Estado -->
          <div>
            <label class="block text-xs font-medium text-gray-700 mb-1">Estado</label>
            <select
              id="editarAreaStatus"
              name="status"
              class="w-full border rounded-lg px-3 py-2 bg-white focus:outline-none focus:ring-1 focus:ring-[#2E7D32]">
              <option value="active">Activa</option>
              <option value="inactive">Inactiva</option>
            </select>
          </div>

          <!-- Footer (Editar) -->
          <div class="flex justify-end gap-2 pt-2">
            <button
              type="button"
              onclick="toggleModal('modalNuevaArea', false)"
              class="px-3 py-1.5 rounded-lg text-xs border text-gray-600 hover:bg-gray-50">
              Cancelar
            </button>
            <button
              type="submit"
              class="px-3 py-1.5 rounded-lg text-xs bg-[#0288D1] text-white hover:bg-[#0277BD]">
              Guardar cambios
            </button>
          </div>
        </form>
      </div>
    </div>

  </div>
</div>

<!-- MODAL: Registrar / Editar usuario -->
<div
  id="modalNuevoUsuario"
  class="fixed inset-0 z-40 hidden items-center justify-center bg-black/40">
  <div class="bg-white rounded-2xl shadow-lg w-full max-w-md mx-4">
    <!-- Header -->
    <div class="px-5 py-3 border-b flex justify-between items-center">
      <h3 class="text-base font-semibold text-gray-800">
        Gestión de usuarios
      </h3>
      <button
        type="button"
        class="text-gray-500 hover:text-gray-700"
        onclick="toggleModal('modalNuevoUsuario', false)">
        ✕
      </button>
    </div>

    <!-- Tabs -->
    <div class="px-5 pt-3 border-b flex gap-4 text-sm">
      <button
        id="tabUsuarioRegistrar"
        type="button"
        class="pb-2 border-b-2 border-[#2E7D32] text-[#2E7D32] font-medium"
        onclick="switchUsuarioTab('registrar')">
        Registrar usuario
      </button>
      <button
        id="tabUsuarioEditar"
        type="button"
        class="pb-2 border-b-2 border-transparent text-gray-500 hover:text-gray-700"
        onclick="switchUsuarioTab('editar')">
        Editar usuario
      </button>
    </div>

    <!-- Contenido -->
    <div class="px-5 py-4 text-sm">
      <!-- TAB: REGISTRAR -->
      <div id="tabContentUsuarioRegistrar" class="space-y-3">
        <form
          id="formNuevoUsuario"
          class="space-y-3">

          <!-- Nombre -->
          <div>
            <label class="block text-xs font-medium text-gray-700 mb-1">Nombre completo</label>
            <input
              type="text"
              name="name"
              class="w-full border rounded-lg px-3 py-2 focus:outline-none focus:ring-1 focus:ring-[#2E7D32]"
              placeholder="Ej: Juan Pérez"
              required>
          </div>

          <!-- Correo -->
          <div>
            <label class="block text-xs font-medium text-gray-700 mb-1">Correo corporativo</label>
            <input
              type="email"
              name="email"
              class="w-full border rounded-lg px-3 py-2 focus:outline-none focus:ring-1 focus:ring-[#2E7D32]"
              placeholder="usuario@empresa.cl"
              required>
          </div>

          <!-- Teléfono -->
          <div>
            <label class="block text-xs font-medium text-gray-700 mb-1">Teléfono</label>
            <input
              type="text"
              name="telephone"
              class="w-full border rounded-lg px-3 py-2 focus:outline-none focus:ring-1 focus:ring-[#2E7D32]"
              placeholder="+569...">
          </div>

          <!-- Rol / Estado -->
          <div class="grid gap-3 sm:grid-cols-2">
            <div>
              <label class="block text-xs font-medium text-gray-700 mb-1">Rol</label>
              <select
                name="role"
                class="w-full border rounded-lg px-3 py-2 bg-white focus:outline-none focus:ring-1 focus:ring-[#2E7D32]"
                required>
                <!-- Como admin, solo crearás supervisores: el backend fuerza role_id = 3 -->
                <option value="supervisor" selected>Supervisor</option>
              </select>
              <p class="mt-1 text-[11px] text-gray-400">
                * Como Admin, solo puedes registrar usuarios de tipo Supervisor.
                El sistema asigna automáticamente al Admin actual como jefe directo.
              </p>
            </div>
            <div>
              <label class="block text-xs font-medium text-gray-700 mb-1">Estado</label>
              <select
                name="status"
                class="w-full border rounded-lg px-3 py-2 bg-white focus:outline-none focus:ring-1 focus:ring-[#2E7D32]">
                <option value="active">Activo</option>
                <option value="suspended">Suspendido</option>
              </select>
            </div>
          </div>

          <!-- Área -->
          <div>
            <label class="block text-xs font-medium text-gray-700 mb-1">Área (activas)</label>
            <select
              name="area_id"
              class="w-full border rounded-lg px-3 py-2 bg-white focus:outline-none focus:ring-1 focus:ring-[#2E7D32]"
              required>
              <option value="" disabled selected>Seleccionar área…</option>
              <% if (areas && areas.length) { %>
                <% areas.forEach(function(area) { %>
                  <% if (area.status === 'active') { %>
                    <option value="<%= area.id %>"><%= area.name %></option>
                  <% } %>
                <% }) %>
              <% } %>
            </select>
            <p class="mt-1 text-[11px] text-gray-400">
              * El área es obligatoria para crear un supervisor.
            </p>
          </div>

          <!-- Footer Registrar -->
          <div class="flex justify-end gap-2 pt-2">
            <button
              type="button"
              onclick="toggleModal('modalNuevoUsuario', false)"
              class="px-3 py-1.5 rounded-lg text-xs border text-gray-600 hover:bg-gray-50">
              Cancelar
            </button>
            <button
              type="submit"
              class="px-3 py-1.5 rounded-lg text-xs bg-[#2E7D32] text-white hover:bg-[#1B5E20]">
              Guardar
            </button>
          </div>
        </form>
      </div>

      <!-- TAB: EDITAR -->
      <div id="tabContentUsuarioEditar" class="space-y-3 hidden">
        <form
          id="formEditarUsuario"
          class="space-y-3">

          <!-- Selector de usuario -->
          <div>
            <label class="block text-xs font-medium text-gray-700 mb-1">Supervisor a editar</label>
            <select
              id="selectUsuarioEditar"
              name="user_id"
              class="w-full border rounded-lg px-3 py-2 bg-white focus:outline-none focus:ring-1 focus:ring-[#2E7D32]"
              required>
              <option value="">Seleccionar usuario…</option>
              <!-- Se rellena vía JS con /api/users -->
            </select>
            <p class="mt-1 text-[11px] text-gray-400">
              * Como Admin, solo podrás editar supervisores de tu empresa.
            </p>
          </div>

          <!-- Nombre -->
          <div>
            <label class="block text-xs font-medium text-gray-700 mb-1">Nombre completo</label>
            <input
              type="text"
              id="editarUsuarioName"
              name="name"
              class="w-full border rounded-lg px-3 py-2 focus:outline-none focus:ring-1 focus:ring-[#2E7D32]"
              required>
          </div>

          <!-- Correo -->
          <div>
            <label class="block text-xs font-medium text-gray-700 mb-1">Correo corporativo</label>
            <input
              type="email"
              id="editarUsuarioEmail"
              name="email"
              class="w-full border rounded-lg px-3 py-2 focus:outline-none focus:ring-1 focus:ring-[#2E7D32]"
              required>
          </div>

          <!-- Teléfono -->
          <div>
            <label class="block text-xs font-medium text-gray-700 mb-1">Teléfono</label>
            <input
              type="text"
              id="editarUsuarioTelephone"
              name="telephone"
              class="w-full border rounded-lg px-3 py-2 focus:outline-none focus:ring-1 focus:ring-[#2E7D32]">
          </div>

          <!-- Rol / Estado -->
          <div class="grid gap-3 sm:grid-cols-2">
            <div>
              <label class="block text-xs font-medium text-gray-700 mb-1">Rol</label>
              <select
                id="editarUsuarioRole"
                name="role"
                class="w-full border rounded-lg px-3 py-2 bg-gray-100 text-gray-600"
                disabled>
                <option value="supervisor" selected>Supervisor</option>
              </select>
            </div>
            <div>
              <label class="block text-xs font-medium text-gray-700 mb-1">Estado</label>
              <select
                id="editarUsuarioStatus"
                name="status"
                class="w-full border rounded-lg px-3 py-2 bg-white focus:outline-none focus:ring-1 focus:ring-[#2E7D32]">
                <option value="active">Activo</option>
                <option value="suspended">Suspendido</option>
              </select>
            </div>
          </div>

          <!-- Área -->
          <div>
            <label class="block text-xs font-medium text-gray-700 mb-1">Área</label>
            <select
              id="editarUsuarioArea"
              name="area_id"
              class="w-full border rounded-lg px-3 py-2 bg-white focus:outline-none focus:ring-1 focus:ring-[#2E7D32]">
              <option value="">Seleccionar área…</option>
              <% if (areas && areas.length) { %>
                <% areas.forEach(function(area) { %>
                  <% if (area.status === 'active') { %>
                    <option value="<%= area.id %>"><%= area.name %></option>
                  <% } %>
                <% }) %>
              <% } %>
            </select>
            <p class="mt-1 text-[11px] text-gray-400">
              * El área es obligatoria para supervisores.
            </p>
          </div>

          <!-- Footer Editar -->
          <div class="flex justify-end gap-2 pt-2">
            <button
              type="button"
              onclick="toggleModal('modalNuevoUsuario', false)"
              class="px-3 py-1.5 rounded-lg text-xs border text-gray-600 hover:bg-gray-50">
              Cancelar
            </button>

            <!-- Resetear contraseña a la genérica -->
            <button
              type="button"
              onclick="resetPasswordUsuarioAdmin()"
              class="px-3 py-1.5 rounded-lg text-xs border border-amber-400 text-amber-600 hover:bg-amber-50">
              Reset pass genérica
            </button>

            <button
              type="submit"
              class="px-3 py-1.5 rounded-lg text-xs bg-[#2E7D32] text-white hover:bg-[#1B5E20]">
              Guardar cambios
            </button>
          </div>
        </form>
      </div>
    </div>

  </div>
</div>

<!-- MODAL: Nuevo grupo de trabajo -->
<div
  id="modalNuevoGrupo"
  class="fixed inset-0 z-40 hidden items-center justify-center bg-black/40">
  <div class="bg-white rounded-2xl shadow-lg w-full max-w-md mx-4">
    <!-- Header -->
    <div class="px-5 py-3 border-b flex justify-between items-center">
      <h3 class="text-base font-semibold text-gray-800">
        Registrar grupo de trabajo
      </h3>
      <button
        type="button"
        class="text-gray-500 hover:text-gray-700"
        onclick="toggleModal('modalNuevoGrupo', false)">
        ✕
      </button>
    </div>

    <!-- Form -->
    <form
      id="formNuevoGrupo"
      class="px-5 py-4 space-y-3 text-sm">

      <!-- Nombre del grupo -->
      <div>
        <label class="block text-xs font-medium text-gray-700 mb-1">
          Nombre del grupo de trabajo
        </label>
        <input
          type="text"
          name="name"
          class="w-full border rounded-lg px-3 py-2 focus:outline-none focus:ring-1 focus:ring-[#7B1FA2]"
          placeholder="Ej: Proyecto ERP Planta, Comité Seguridad, Turno Mixto Noche"
          required>
      </div>

      <!-- Tipo / Estado -->
      <div class="grid gap-3 sm:grid-cols-2">
        <div>
          <label class="block text-xs font-medium text-gray-700 mb-1">
            Tipo de grupo
          </label>
          <select
            name="type"
            class="w-full border rounded-lg px-3 py-2 bg-white focus:outline-none focus:ring-1 focus:ring-[#7B1FA2]">
            <option value="">Seleccionar…</option>
            <option value="area_team">Equipo de área</option>
            <option value="project">Proyecto puntual</option>
            <option value="committee">Comité permanente</option>
            <option value="shift">Turno / cuadrilla</option>
            <option value="other">Otro</option>
          </select>
        </div>
        <div>
          <label class="block text-xs font-medium text-gray-700 mb-1">
            Estado
          </label>
          <select
            name="status"
            class="w-full border rounded-lg px-3 py-2 bg-white focus:outline-none focus:ring-1 focus:ring-[#7B1FA2]">
            <option value="active">Activo</option>
            <option value="paused">Pausado</option>
            <option value="closed">Cerrado</option>
          </select>
        </div>
      </div>

      <!-- Descripción -->
      <div>
        <label class="block text-xs font-medium text-gray-700 mb-1">
          Descripción / alcance
        </label>
        <textarea
          name="description"
          rows="2"
          class="w-full border rounded-lg px-3 py-2 focus:outline-none focus:ring-1 focus:ring-[#7B1FA2]"
          placeholder="Ej: Grupo transversal para coordinar tareas entre Operaciones, Calidad y TI."></textarea>
      </div>

      <!-- Footer -->
      <div class="flex justify-end gap-2 pt-2">
        <button
          type="button"
          onclick="toggleModal('modalNuevoGrupo', false)"
          class="px-3 py-1.5 rounded-lg text-xs border text-gray-600 hover:bg-gray-50">
          Cancelar
        </button>
        <button
          type="submit"
          class="px-3 py-1.5 rounded-lg text-xs bg-[#7B1FA2] text-white hover:bg-[#6A1B9A]">
          Guardar (UI)
        </button>
      </div>
    </form>
  </div>
</div>

<!-- MODAL: Editar miembros de grupo -->
<div
  id="modalEditarGrupo"
  class="fixed inset-0 z-40 hidden items-center justify-center bg-black/40">
  <div class="bg-white rounded-2xl shadow-lg w-full max-w-3xl mx-4">
    <!-- Header -->
    <div class="px-5 py-3 border-b flex justify-between items-center">
      <h3 class="text-base font-semibold text-gray-800">
        Editar miembros del grupo
      </h3>
      <button
        type="button"
        class="text-gray-500 hover:text-gray-700"
        onclick="toggleModal('modalEditarGrupo', false)">
        ✕
      </button>
    </div>

    <!-- Body -->
    <div class="px-5 py-4 space-y-4 text-sm">
      <!-- Selección de grupo -->
      <div class="grid gap-3 sm:grid-cols-3 items-end">
        <div class="sm:col-span-2">
          <label class="block text-xs font-medium text-gray-700 mb-1">
            Grupo de trabajo
          </label>
          <select
            id="grupoSeleccionado"
            class="w-full border rounded-lg px-3 py-2 bg-white focus:outline-none focus:ring-1 focus:ring-[#7B1FA2]">
            <option value="">Seleccionar grupo…</option>
            <!-- Opciones desde backend (teams) -->
          </select>
        </div>
        <div class="flex gap-2 justify-end">
          <button
            type="button"
            class="px-3 py-1.5 rounded-lg text-xs border text-gray-600 hover:bg-gray-50">
            Refrescar
          </button>
        </div>
      </div>

      <!-- Filtros de usuarios -->
      <div class="grid gap-3 sm:grid-cols-3">
        <div>
          <label class="block text-xs font-medium text-gray-700 mb-1">
            Área
          </label>
          <select
            id="filtroArea"
            class="w-full border rounded-lg px-3 py-2 bg-white focus:outline-none focus:ring-1 focus:ring-[#7B1FA2]">
            <option value="">Todas las áreas…</option>
            <!-- Rellenar con areas de la empresa -->
          </select>
        </div>
        <div>
          <label class="block text-xs font-medium text-gray-700 mb-1">
            Tipo de usuario
          </label>
          <select
            id="filtroTipoUsuario"
            class="w-full border rounded-lg px-3 py-2 bg-white focus:outline-none focus:ring-1 focus:ring-[#7B1FA2]">
            <option value="">Supervisores y trabajadores</option>
            <option value="supervisor">Solo supervisores</option>
            <option value="user">Solo trabajadores</option>
          </select>
        </div>
        <div>
          <label class="block text-xs font-medium text-gray-700 mb-1">
            Buscar por nombre
          </label>
          <input
            type="text"
            id="buscadorUsuarioGrupo"
            class="w-full border rounded-lg px-3 py-2 focus:outline-none focus:ring-1 focus:ring-[#7B1FA2]"
            placeholder="Ej: Diego, Juan, etc.">
        </div>
      </div>

      <!-- Listas de usuarios -->
      <div class="grid gap-4 sm:grid-cols-2">
        <!-- Disponibles -->
        <div>
          <h4 class="text-xs font-semibold text-gray-700 mb-2">
            Usuarios disponibles
            <span class="text-[11px] text-gray-400 block">
              (Supervisores y trabajadores de la empresa)
            </span>
          </h4>
          <div class="border rounded-lg h-56 overflow-y-auto">
            <ul id="listaUsuariosDisponibles" class="divide-y text-xs">
              <!-- Ejemplo estático -->
              <li class="flex items-center justify-between px-3 py-2 hover:bg-gray-50">
                <div>
                  <p class="font-medium text-gray-800">Juan Soto</p>
                  <p class="text-[11px] text-gray-500">Supervisor · Operaciones</p>
                </div>
                <button
                  type="submit"
                  class="text-[11px] px-2 py-1 rounded border border-[#7B1FA2] text-[#7B1FA2] hover:bg-[#F3E5F5]">
                  Agregar
                </button>
              </li>
              <!-- luego se rellena dinámico -->
            </ul>
          </div>
        </div>

        <!-- Miembros del grupo -->
        <div>
          <h4 class="text-xs font-semibold text-gray-700 mb-2">
            Miembros del grupo
            <span class="text-[11px] text-gray-400 block">
              (Supervisores y trabajadores actualmente asignados)
            </span>
          </h4>
          <div class="border rounded-lg h-56 overflow-y-auto">
            <ul id="listaMiembrosGrupo" class="divide-y text-xs">
              <!-- Ejemplo estático -->
              <li class="flex items-center justify-between px-3 py-2 hover:bg-gray-50">
                <div>
                  <p class="font-medium text-gray-800">María Rojas</p>
                  <p class="text-[11px] text-gray-500">Trabajadora · Mantenimiento</p>
                </div>
                <button
                  type="submit"
                  class="text-[11px] px-2 py-1 rounded border border-red-400 text-red-500 hover:bg-red-50">
                  Quitar
                </button>
              </li>
              <!-- luego se rellena dinámico -->
            </ul>
          </div>
        </div>
      </div>
    </div>

    <!-- Footer -->
    <div class="px-5 py-3 border-t flex justify-end gap-2">
      <button
        type="button"
        onclick="toggleModal('modalEditarGrupo', false)"
        class="px-3 py-1.5 rounded-lg text-xs border text-gray-600 hover:bg-gray-50">
        Cerrar
      </button>
      <button
        type="button"
        class="px-3 py-1.5 rounded-lg text-xs bg-[#7B1FA2] text-white hover:bg-[#6A1B9A]">
        Guardar cambios (UI)
      </button>
    </div>
  </div>
</div>

<!-- Helpers JS mínimos para los modals -->
<script>
  function handleAdminQuickAction(selectEl) {
    const value = selectEl.value;
    if (!value) return;

    if (value === 'nuevoUsuario') {
      toggleModal('modalNuevoUsuario', true);
    }
    if (value === 'nuevaArea') {
      toggleModal('modalNuevaArea', true);
    }
    if (value === 'nuevoGrupo') {
      toggleModal('modalNuevoGrupo', true);
    }
    if (value === 'editarGrupo') {
      toggleModal('modalEditarGrupo', true);
    }

    // reset del select
    selectEl.value = '';
  }
</script>

<!-- Script: Control de pestañas para registrar / editar áreas -->
<script>
  function switchAreaTab(tab) {
    const tabRegistrar = document.getElementById('tabAreaRegistrar');
    const tabEditar = document.getElementById('tabAreaEditar');
    const contentRegistrar = document.getElementById('tabContentAreaRegistrar');
    const contentEditar = document.getElementById('tabContentAreaEditar');

    if (tab === 'registrar') {
      tabRegistrar.classList.add('border-[#2E7D32]', 'text-[#2E7D32]');
      tabRegistrar.classList.remove('border-transparent', 'text-gray-500');
      tabEditar.classList.add('border-transparent', 'text-gray-500');
      tabEditar.classList.remove('border-[#2E7D32]', 'text-[#2E7D32]');

      contentRegistrar.classList.remove('hidden');
      contentEditar.classList.add('hidden');
    } else {
      tabEditar.classList.add('border-[#2E7D32]', 'text-[#2E7D32]');
      tabEditar.classList.remove('border-transparent', 'text-gray-500');
      tabRegistrar.classList.add('border-transparent', 'text-gray-500');
      tabRegistrar.classList.remove('border-[#2E7D32]', 'text-[#2E7D32]');

      contentEditar.classList.remove('hidden');
      contentRegistrar.classList.add('hidden');
    }
  }
</script>

<!-- Función: Editar áreas (flujo completo) -->
<script>
  const selectAreaEditar = document.getElementById('selectAreaEditar');
  const formEditarArea = document.getElementById('formEditarArea');
  const inputEditarName = document.getElementById('editarAreaName');
  const inputEditarDesc = document.getElementById('editarAreaDescription');
  const selectEditarStatus = document.getElementById('editarAreaStatus');

  if (selectAreaEditar && formEditarArea) {
    // 1) Cuando se elije un área del combo, se cargan sus datos desde la API
    selectAreaEditar.addEventListener('change', async () => {
      const id = selectAreaEditar.value;
      if (!id) return;

      try {
        const res = await fetch(`/api/areas/${id}`, {
          credentials: 'same-origin'
        });
        const data = await res.json();

        if (!data.ok) {
          alert(data.message || 'No se pudo cargar el área');
          return;
        }

        const area = data.data;
        inputEditarName.value = area.name || '';
        inputEditarDesc.value = area.description || '';
        selectEditarStatus.value = area.status || 'active';
      } catch (err) {
        console.error(err);
        alert('Error al cargar el área');
      }
    });

    // 2) Al enviar el formulario, se mandan los cambios a /api/areas/:id/edit
    formEditarArea.addEventListener('submit', async (e) => {
      e.preventDefault();
      const id = selectAreaEditar.value;

      if (!id) {
        alert('Selecciona un área primero');
        return;
      }

      try {
        const body = new URLSearchParams(new FormData(formEditarArea));

        const res = await fetch(`/api/areas/${id}/edit`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/x-www-form-urlencoded;charset=UTF-8'
          },
          body,
          credentials: 'same-origin'
        });

        const data = await res.json();
        alert(data.message || 'Cambios guardados');

        if (data.ok) {
          // se recarga para ver los cambios reflejados en la UI
          window.location.reload();
        }
      } catch (err) {
        console.error(err);
        alert('Error al actualizar el área');
      }
    });
  }
</script>

<!-- Script: Control de pestañas para registrar / editar usuarios -->
<script>
  function switchUsuarioTab(tab) {
    const tabRegistrar = document.getElementById('tabUsuarioRegistrar');
    const tabEditar = document.getElementById('tabUsuarioEditar');
    const contentRegistrar = document.getElementById('tabContentUsuarioRegistrar');
    const contentEditar = document.getElementById('tabContentUsuarioEditar');

    if (tab === 'registrar') {
      tabRegistrar.classList.add('border-[#2E7D32]', 'text-[#2E7D32]');
      tabRegistrar.classList.remove('border-transparent', 'text-gray-500');
      tabEditar.classList.add('border-transparent', 'text-gray-500');
      tabEditar.classList.remove('border-[#2E7D32]', 'text-[#2E7D32]');

      contentRegistrar.classList.remove('hidden');
      contentEditar.classList.add('hidden');
    } else {
      tabEditar.classList.add('border-[#2E7D32]', 'text-[#2E7D32]');
      tabEditar.classList.remove('border-transparent', 'text-gray-500');
      tabRegistrar.classList.add('border-transparent', 'text-gray-500');
      tabRegistrar.classList.remove('border-[#2E7D32]', 'text-[#2E7D32]');

      contentEditar.classList.remove('hidden');
      contentRegistrar.classList.add('hidden');
    }
  }
</script>

<!-- Función: Editar usuarios (flujo completo) -->
<script>
  const selectUsuarioEditar = document.getElementById('selectUsuarioEditar');
  const formEditarUsuario = document.getElementById('formEditarUsuario');

  const inputUsuarioName = document.getElementById('editarUsuarioName');
  const inputUsuarioEmail = document.getElementById('editarUsuarioEmail');
  const inputUsuarioTel = document.getElementById('editarUsuarioTelephone');
  const selectUsuarioRole = document.getElementById('editarUsuarioRole');
  const selectUsuarioStatus = document.getElementById('editarUsuarioStatus');
  const selectUsuarioArea = document.getElementById('editarUsuarioArea');
  const selectUsuarioManager = document.getElementById('editarUsuarioManager');

  async function cargarUsuariosParaEditar() {
    try {
      const res = await fetch('/api/users', { credentials: 'same-origin' });
      const data = await res.json();

      if (!data.ok || !Array.isArray(data.data)) {
        alert(data.message || 'No se pudieron cargar los usuarios');
        return;
      }

      if (!selectUsuarioEditar) return;

      // Limpiar opciones actuales (menos el placeholder)
      while (selectUsuarioEditar.options.length > 1) {
        selectUsuarioEditar.remove(1);
      }

      // Solo mostrar SUPERVISORES (role_id = 3) para edición por Admin
      data.data
        .filter(u => u.role_id === 3)
        .forEach((u) => {
          const opt = document.createElement('option');
          opt.value = u.id;
          opt.textContent = `${u.name} (${u.email})`;
          selectUsuarioEditar.appendChild(opt);
        });
    } catch (err) {
      console.error(err);
      alert('Error al cargar usuarios');
    }
  }

  if (selectUsuarioEditar && formEditarUsuario) {
    // Cargamos lista de usuarios al abrir la vista
    cargarUsuariosParaEditar();

    // Cuando se selecciona un usuario, traemos sus datos
    selectUsuarioEditar.addEventListener('change', async () => {
      const id = selectUsuarioEditar.value;
      if (!id) return;

      try {
        const res = await fetch(`/api/users/${id}`, {
          credentials: 'same-origin'
        });
        const data = await res.json();

        if (!data.ok || !data.data) {
          alert(data.message || 'No se pudo cargar el usuario');
          return;
        }

        const u = data.data || {};

        // Campos básicos
        if (inputUsuarioName) {
          inputUsuarioName.value = u.name || '';
        }
        if (inputUsuarioEmail) {
          inputUsuarioEmail.value = u.email || '';
        }
        if (inputUsuarioTel) {
          inputUsuarioTel.value = u.telephone || '';
        }

        // Rol (informativo: en Admin siempre debería ser supervisor)
        if (selectUsuarioRole) {
          if (u.role_id === 2) selectUsuarioRole.value = 'admin';
          else if (u.role_id === 3) selectUsuarioRole.value = 'supervisor';
          else selectUsuarioRole.value = 'user';
        }

        // Estado
        if (selectUsuarioStatus) {
          selectUsuarioStatus.value = u.status || 'active';
        }

        // Área
        if (selectUsuarioArea) {
          if (u.area_id) {
            selectUsuarioArea.value = String(u.area_id);
          } else {
            selectUsuarioArea.value = '';
          }
        }

        // Jefe directo (solo informativo en UI; backend forzará manager_id = admin)
        if (selectUsuarioManager) {
          if (u.manager_id) {
            selectUsuarioManager.value = String(u.manager_id);
          } else {
            selectUsuarioManager.value = '';
          }
        }
      } catch (err) {
        console.error(err);
        alert('Error al cargar el usuario');
      }
    });

    // Enviar cambios
    formEditarUsuario.addEventListener('submit', async (e) => {
      e.preventDefault();
      const id = selectUsuarioEditar.value;

      if (!id) {
        alert('Selecciona un usuario primero');
        return;
      }

      try {
        const body = new URLSearchParams(new FormData(formEditarUsuario));

        const res = await fetch(`/api/users/${id}/edit`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/x-www-form-urlencoded;charset=UTF-8'
          },
          body,
          credentials: 'same-origin'
        });

        const data = await res.json();
        alert(data.message || 'Cambios guardados');

        if (data.ok) {
          window.location.reload();
        }
      } catch (err) {
        console.error(err);
        alert('Error al actualizar el usuario');
      }
    });
  }

  async function resetPasswordUsuarioAdmin() {
    if (!selectUsuarioEditar) {
      alert('No se encontró el selector de usuarios.');
      return;
    }

    const id = selectUsuarioEditar.value;
    if (!id) {
      alert('Selecciona un usuario primero.');
      return;
    }

    const confirmar = confirm(
      '¿Seguro que deseas resetear la contraseña de este usuario ' +
      'a la contraseña genérica del sistema?'
    );
    if (!confirmar) return;

    try {
      const res = await fetch(`/api/users/${id}/reset-password`, {
        method: 'POST',
        headers: {
          'Content-Type': 'application/x-www-form-urlencoded;charset=UTF-8'
        },
        credentials: 'same-origin'
      });

      const data = await res.json();
      alert(data.message || 'Operación realizada.');
    } catch (err) {
      console.error(err);
      alert('Error al resetear la contraseña.');
    }
  }
</script>
