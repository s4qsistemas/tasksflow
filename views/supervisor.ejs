<!-- Navbar (privadas) -->
<nav class="bg-white shadow">
  <div class="max-w-7xl mx-auto px-4 py-3 flex justify-between items-center">

    <!-- Izquierda: logo más bienvenida -->
    <a href="javascript:void(0)" class="flex items-center gap-2">
      <img src="/img/logo.png" alt="TasksFlow" class="h-16 w-auto">
      <span class="font-semibold text-lg text-[#2E7D32] hidden sm:inline">
        <%= user ? user.name : 'TasksFlow' %>
      </span>
    </a>

    <!-- Derecha: toggle Kanban + Nuevo usuario + Logout -->
    <div class="flex items-center gap-4">
      <!-- Toggle vista Kanban -->
      <label
        id="kanbanToggleLabel"
        class="inline-flex items-center gap-1 px-3 py-1 rounded-lg border text-sm cursor-pointer bg-white text-gray-700 hover:bg-[#E8F5E9]">
        <input
          id="kanbanToggle"
          type="checkbox"
          class="sr-only"
          onchange="toggleKanbanView(this)">
        <span class="material-icons text-base">view_module</span>
        <span>Kanban</span>
      </label>

      <!-- NUEVO: botón para registrar trabajador -->
      <button
        type="button"
        onclick="toggleModal('modalNuevoUsuario', true)"
        class="inline-flex items-center gap-1 px-3 py-1 rounded-lg bg-[#2E7D32] text-white text-sm hover:bg-[#1B5E20]">
        <span class="material-symbols-outlined text-sm">person_add</span>
        <span>Nuevo usuario</span>
      </button>

      <a href="/logout"
        onclick="return doLogout()"
        class="px-3 py-1 rounded-lg bg-[#F87171] text-white hover:bg-[#EF4444]">
        Logout
      </a>
    </div>
  </div>
</nav>

<main class="max-w-6xl mx-auto my-8">

<script>
  // Id del supervisor actual para filtrar solo sus trabajadores
  window.currentUserId = `<%= user ? user.id : '' %>`;
</script>

  <!-- VISTA DASHBOARD SUPERVISOR -->
  <section
    id="supervisorDashboardView"
    class="bg-white rounded-2xl p-6 shadow">
    <h2 class="text-xl font-semibold text-[#2E7D32] mb-2">Panel Supervisor</h2>
    <p class="text-sm text-gray-600 mb-4">
      Gestión de equipo y tareas asignadas a tu área.
    </p>

    <!-- Aquí después puedes meter tarjetas de métricas, gráficos, etc. -->
    <div class="grid gap-4 sm:grid-cols-3">
      <div class="bg-[#F1F8E9] rounded-xl p-4">
        <p class="text-xs text-gray-500 mb-1">Tareas abiertas</p>
        <p class="text-2xl font-semibold text-[#33691E]">0</p>
      </div>
      <div class="bg-[#E3F2FD] rounded-xl p-4">
        <p class="text-xs text-gray-500 mb-1">En progreso</p>
        <p class="text-2xl font-semibold text-[#1565C0]">0</p>
      </div>
      <div class="bg-[#FFF3E0] rounded-xl p-4">
        <p class="text-xs text-gray-500 mb-1">Completadas</p>
        <p class="text-2xl font-semibold text-[#EF6C00]">0</p>
      </div>
    </div>
  </section>

  <!-- VISTA KANBAN SUPERVISOR (inicialmente oculta) -->
  <section
    id="supervisorKanbanView"
    class="bg-white rounded-2xl p-6 shadow hidden">
    <div class="flex justify-between items-center mb-4">
      <div>
        <h2 class="text-xl font-semibold text-[#2E7D32]">Tablero Kanban</h2>
        <p class="text-sm text-gray-600">Visualización de tareas por estado.</p>
      </div>
    </div>

    <!-- Kanban simple placeholder -->
    <div class="grid gap-4 md:grid-cols-3">
      <div class="bg-[#F1F8E9] rounded-xl p-3">
        <h3 class="text-sm font-semibold text-gray-700 mb-2">To Do</h3>
        <p class="text-xs text-gray-500">Sin tareas asignadas todavía.</p>
      </div>
      <div class="bg-[#E3F2FD] rounded-xl p-3">
        <h3 class="text-sm font-semibold text-gray-700 mb-2">In Progress</h3>
        <p class="text-xs text-gray-500">Aquí verás tareas en ejecución.</p>
      </div>
      <div class="bg-[#FFF3E0] rounded-xl p-3">
        <h3 class="text-sm font-semibold text-gray-700 mb-2">Done</h3>
        <p class="text-xs text-gray-500">Tareas completadas por tu equipo.</p>
      </div>
    </div>
  </section>

  <!-- MODAL: Registrar / Editar usuario (Supervisor -> Trabajadores) -->
  <div
    id="modalNuevoUsuario"
    class="fixed inset-0 z-40 hidden items-center justify-center bg-black/40">
    <div class="bg-white rounded-2xl shadow-lg w-full max-w-md mx-4">
      <!-- Header -->
      <div class="px-5 py-3 border-b flex justify-between items-center">
        <h3 class="text-base font-semibold text-gray-800">
          Gestión de usuarios del equipo
        </h3>
        <button
          type="button"
          class="text-gray-500 hover:text-gray-700"
          onclick="toggleModal('modalNuevoUsuario', false)">
          ✕
        </button>
      </div>

      <!-- Tabs -->
      <div class="px-5 pt-3 border-b flex gap-4 text-sm">
        <button
          id="tabUsuarioRegistrar"
          type="button"
          class="pb-2 border-b-2 border-[#2E7D32] text-[#2E7D32] font-medium"
          onclick="switchUsuarioTab('registrar')">
          Registrar usuario
        </button>
        <button
          id="tabUsuarioEditar"
          type="button"
          class="pb-2 border-b-2 border-transparent text-gray-500 hover:text-gray-700"
          onclick="switchUsuarioTab('editar')">
          Editar usuario
        </button>
      </div>

      <!-- Contenido -->
      <div class="px-5 py-4 text-sm">
        <!-- TAB: REGISTRAR -->
        <div id="tabContentUsuarioRegistrar" class="space-y-3">
          <form
            id="formNuevoUsuario"
            class="space-y-3">

            <!-- Nombre -->
            <div>
              <label class="block text-xs font-medium text-gray-700 mb-1">Nombre completo</label>
              <input
                type="text"
                name="name"
                class="w-full border rounded-lg px-3 py-2 focus:outline-none focus:ring-1 focus:ring-[#2E7D32]"
                placeholder="Ej: Juan Pérez"
                required>
            </div>

            <!-- Correo -->
            <div>
              <label class="block text-xs font-medium text-gray-700 mb-1">Correo corporativo</label>
              <input
                type="email"
                name="email"
                class="w-full border rounded-lg px-3 py-2 focus:outline-none focus:ring-1 focus:ring-[#2E7D32]"
                placeholder="usuario@empresa.cl"
                required>
            </div>

            <!-- Teléfono -->
            <div>
              <label class="block text-xs font-medium text-gray-700 mb-1">Teléfono</label>
              <input
                type="text"
                name="telephone"
                class="w-full border rounded-lg px-3 py-2 focus:outline-none focus:ring-1 focus:ring-[#2E7D32]"
                placeholder="+569...">
            </div>

            <!-- Rol fijo / Estado -->
            <div class="grid gap-3 sm:grid-cols-2">
              <div>
                <label class="block text-xs font-medium text-gray-700 mb-1">Rol</label>
                <input
                  type="text"
                  value="Trabajador"
                  disabled
                  class="w-full border rounded-lg px-3 py-2 bg-gray-100 text-gray-600 text-xs">
                <p class="mt-1 text-[11px] text-gray-400">
                  * Como Supervisor, solo puedes registrar usuarios de tipo Trabajador.
                  El sistema asigna automáticamente el rol, el área y el jefe directo.
                </p>
              </div>
              <div>
                <label class="block text-xs font-medium text-gray-700 mb-1">Estado</label>
                <select
                  name="status"
                  class="w-full border rounded-lg px-3 py-2 bg-white focus:outline-none focus:ring-1 focus:ring-[#2E7D32]">
                  <option value="active">Activo</option>
                  <option value="suspended">Suspendido</option>
                </select>
              </div>
            </div>

            <!-- Footer -->
            <div class="flex justify-end gap-2 pt-2">
              <button
                type="button"
                onclick="toggleModal('modalNuevoUsuario', false)"
                class="px-3 py-1.5 rounded-lg text-xs border text-gray-600 hover:bg-gray-50">
                Cancelar
              </button>
              <button
                type="submit"
                class="px-3 py-1.5 rounded-lg text-xs bg-[#2E7D32] text-white hover:bg-[#1B5E20]">
                Guardar
              </button>
            </div>
          </form>
        </div>

        <!-- TAB: EDITAR -->
        <div id="tabContentUsuarioEditar" class="space-y-3 hidden">
          <form
            id="formEditarUsuario"
            class="space-y-3">

            <!-- Selector de usuario -->
            <div>
              <label class="block text-xs font-medium text-gray-700 mb-1">Trabajador a editar</label>
              <select
                id="selectUsuarioEditar"
                name="user_id"
                class="w-full border rounded-lg px-3 py-2 bg-white focus:outline-none focus:ring-1 focus:ring-[#2E7D32]"
                required>
                <option value="">Seleccionar usuario…</option>
                <!-- Se rellena vía JS con /api/users (solo tus trabajadores) -->
              </select>
              <p class="mt-1 text-[11px] text-gray-400">
                * Solo verás usuarios de tipo Trabajador que estén a tu cargo.
              </p>
            </div>

            <!-- Nombre -->
            <div>
              <label class="block text-xs font-medium text-gray-700 mb-1">Nombre completo</label>
              <input
                type="text"
                id="editarUsuarioName"
                name="name"
                class="w-full border rounded-lg px-3 py-2 focus:outline-none focus:ring-1 focus:ring-[#2E7D32]"
                required>
            </div>

            <!-- Correo -->
            <div>
              <label class="block text-xs font-medium text-gray-700 mb-1">Correo corporativo</label>
              <input
                type="email"
                id="editarUsuarioEmail"
                name="email"
                class="w-full border rounded-lg px-3 py-2 focus:outline-none focus:ring-1 focus:ring-[#2E7D32]"
                required>
            </div>

            <!-- Teléfono -->
            <div>
              <label class="block text-xs font-medium text-gray-700 mb-1">Teléfono</label>
              <input
                type="text"
                id="editarUsuarioTelephone"
                name="telephone"
                class="w-full border rounded-lg px-3 py-2 focus:outline-none focus:ring-1 focus:ring-[#2E7D32]">
            </div>

            <!-- Estado (rol y área quedan fijos según backend) -->
            <div>
              <label class="block text-xs font-medium text-gray-700 mb-1">Estado</label>
              <select
                id="editarUsuarioStatus"
                name="status"
                class="w-full border rounded-lg px-3 py-2 bg-white focus:outline-none focus:ring-1 focus:ring-[#2E7D32]">
                <option value="active">Activo</option>
                <option value="suspended">Suspendido</option>
              </select>
              <p class="mt-1 text-[11px] text-gray-400">
                * Rol, área y jefe directo se mantienen según configuración del sistema.
              </p>
            </div>

            <!-- Footer Editar -->
            <div class="flex justify-end gap-2 pt-2">
              <button
                type="button"
                onclick="toggleModal('modalNuevoUsuario', false)"
                class="px-3 py-1.5 rounded-lg text-xs border text-gray-600 hover:bg-gray-50">
                Cancelar
              </button>

              <!-- Resetear contraseña a la genérica -->
              <button
                type="button"
                onclick="resetPasswordUsuarioSupervisor()"
                class="px-3 py-1.5 rounded-lg text-xs border border-amber-400 text-amber-600 hover:bg-amber-50">
                Reset pass genérica
              </button>

              <button
                type="submit"
                class="px-3 py-1.5 rounded-lg text-xs bg-[#2E7D32] text-white hover:bg-[#1B5E20]">
                Guardar cambios
              </button>
            </div>
          </form>
        </div>
      </div>

    </div>
  </div>

</main>

<!-- Script: Control de pestañas para registrar / editar users -->
<script>
  function switchUsuarioTab(tab) {
    const tabRegistrar = document.getElementById('tabUsuarioRegistrar');
    const tabEditar = document.getElementById('tabUsuarioEditar');
    const contentRegistrar = document.getElementById('tabContentUsuarioRegistrar');
    const contentEditar = document.getElementById('tabContentUsuarioEditar');

    if (!tabRegistrar || !tabEditar || !contentRegistrar || !contentEditar) return;

    if (tab === 'registrar') {
      tabRegistrar.classList.add('border-[#2E7D32]', 'text-[#2E7D32]');
      tabRegistrar.classList.remove('border-transparent', 'text-gray-500');
      tabEditar.classList.add('border-transparent', 'text-gray-500');
      tabEditar.classList.remove('border-[#2E7D32]', 'text-[#2E7D32]');

      contentRegistrar.classList.remove('hidden');
      contentEditar.classList.add('hidden');
    } else {
      tabEditar.classList.add('border-[#2E7D32]', 'text-[#2E7D32]');
      tabEditar.classList.remove('border-transparent', 'text-gray-500');
      tabRegistrar.classList.add('border-transparent', 'text-gray-500');
      tabRegistrar.classList.remove('border-[#2E7D32]', 'text-[#2E7D32]');

      contentEditar.classList.remove('hidden');
      contentRegistrar.classList.add('hidden');
    }
  }
</script>

<!-- Función: Editar usuarios (users) -->
<script>
  const selectUsuarioEditar = document.getElementById('selectUsuarioEditar');
  const formEditarUsuario = document.getElementById('formEditarUsuario');

  const inputUsuarioName = document.getElementById('editarUsuarioName');
  const inputUsuarioEmail = document.getElementById('editarUsuarioEmail');
  const inputUsuarioTel = document.getElementById('editarUsuarioTelephone');
  const selectUsuarioStatus = document.getElementById('editarUsuarioStatus');

  async function cargarUsuariosParaEditarSupervisor() {
    if (!selectUsuarioEditar) return;

    try {
      const res = await fetch('/api/users', { credentials: 'same-origin' });
      const data = await res.json();

      if (!data.ok || !Array.isArray(data.data)) {
        alert(data.message || 'No se pudieron cargar los usuarios');
        return;
      }

      const currentId = Number(window.currentUserId || 0);

      // Limpiar opciones actuales (menos el placeholder)
      while (selectUsuarioEditar.options.length > 1) {
        selectUsuarioEditar.remove(1);
      }

      // Solo mostrar TRABAJADORES (role_id = 4) que estén a cargo del supervisor actual
      data.data
        .filter((u) => u.role_id === 4 && Number(u.manager_id) === currentId)
        .forEach((u) => {
          const opt = document.createElement('option');
          opt.value = u.id;
          opt.textContent = `${u.name} (${u.email})`;
          selectUsuarioEditar.appendChild(opt);
        });
    } catch (err) {
      console.error(err);
      alert('Error al cargar usuarios');
    }
  }

  if (selectUsuarioEditar && formEditarUsuario) {
    // 1) Cargamos la lista de usuarios al entrar a la vista
    cargarUsuariosParaEditarSupervisor();

    // 2) Cuando se selecciona un usuario, traemos sus datos
    selectUsuarioEditar.addEventListener('change', async () => {
      const id = selectUsuarioEditar.value;
      if (!id) return;

      try {
        const res = await fetch(`/api/users/${id}`, {
          credentials: 'same-origin'
        });
        const data = await res.json();

        if (!data.ok || !data.data) {
          alert(data.message || 'No se pudo cargar el usuario');
          return;
        }

        const u = data.data || {};

        if (inputUsuarioName)  inputUsuarioName.value  = u.name || '';
        if (inputUsuarioEmail) inputUsuarioEmail.value = u.email || '';
        if (inputUsuarioTel)   inputUsuarioTel.value   = u.telephone || '';
        if (selectUsuarioStatus) {
          selectUsuarioStatus.value = u.status || 'active';
        }
      } catch (err) {
        console.error(err);
        alert('Error al cargar el usuario');
      }
    });

    // 3) Enviar cambios al backend (actualizarUsuario, branch supervisor)
    formEditarUsuario.addEventListener('submit', async (e) => {
      e.preventDefault();
      const id = selectUsuarioEditar.value;

      if (!id) {
        alert('Selecciona un usuario primero');
        return;
      }

      try {
        const body = new URLSearchParams(new FormData(formEditarUsuario));

        const res = await fetch(`/api/users/${id}/edit`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/x-www-form-urlencoded;charset=UTF-8'
          },
          body,
          credentials: 'same-origin'
        });

        const data = await res.json();
        alert(data.message || 'Cambios guardados');

        if (data.ok) {
          window.location.reload();
        }
      } catch (err) {
        console.error(err);
        alert('Error al actualizar el usuario');
      }
    });
  }

  // 4) Resetear contraseña a la genérica (solo trabajadores a cargo)
  async function resetPasswordUsuarioSupervisor() {
    if (!selectUsuarioEditar) {
      alert('No se encontró el selector de usuarios.');
      return;
    }

    const id = selectUsuarioEditar.value;
    if (!id) {
      alert('Selecciona un usuario primero.');
      return;
    }

    const confirmar = confirm(
      '¿Seguro que deseas resetear la contraseña de este usuario ' +
      'a la contraseña genérica del sistema?'
    );
    if (!confirmar) return;

    try {
      const res = await fetch(`/api/users/${id}/reset-password`, {
        method: 'POST',
        headers: {
          'Content-Type': 'application/x-www-form-urlencoded;charset=UTF-8'
        },
        credentials: 'same-origin'
      });

      const data = await res.json();
      alert(data.message || 'Operación realizada.');
    } catch (err) {
      console.error(err);
      alert('Error al resetear la contraseña.');
    }
  }

  // Exponer función al scope global para usarla en onclick
  window.resetPasswordUsuarioSupervisor = resetPasswordUsuarioSupervisor;
</script>
